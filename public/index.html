<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C4 - Gestão para Empreendedoras</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        /* Variáveis CSS para um Design System consistente */
        :root {
            /* Cores Principais */
            --color-primary: #DB1472;
            --color-secondary: #F8B81F;
            --color-accent-pink: #ec4899;
            --color-dark-pink: #c01062;

            /* Cores de Texto */
            --color-text-dark: #1f2937;
            --color-text-primary: #374151;
            --color-text-secondary: #666666;
            --color-text-light: #fce7f3;

            /* Cores de Fundo */
            --bg-light-pink: #fef6fa;
            --bg-soft-pink: #fdf2f8;
            --bg-white: #ffffff;
            --bg-footer: #f8f0f4;

            /* Espaçamentos */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;

            /* Bordas e Sombras */
            --border-radius-sm: 6px;
            --border-radius-md: 10px;
            --border-radius-lg: 12px;
            --box-shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
            --box-shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --box-shadow-lg: 0 6px 14px rgba(0,0,0,0.12);
        }

        /* Estilos básicos para visualização inicial e mobile-first */
        body { 
            font-family: 'Poppins', sans-serif; /* Tipografia sugerida */
            margin: 0; 
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: var(--bg-light-pink);
            position: relative;
            overflow-x: hidden;
        }

        /* Cabeçalho */
        .app-header { 
            background-color: var(--color-primary);
            background-image: linear-gradient(to right, var(--color-primary), var(--color-accent-pink)); 
            color: white; 
            padding: 0.8rem 1rem; 
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        }
        .app-header-title {
            margin: 0;
            font-size: 1.6rem; 
            font-weight: 700; 
        }
        .menu-toggle {
            background: none;
            border: none;
            color: white;
            font-size: 1.8rem; 
            cursor: pointer;
            padding: 0.5rem;
            display: flex; 
            align-items: center;
            justify-content: center;
        }
        .menu-toggle svg {
            width: 30px; 
            height: 30px;
        }

        /* Navegação Lateral (Sidebar) */
        .sidebar-nav {
            height: 100%;
            width: 0; 
            position: fixed;
            z-index: 1001; 
            top: 0;
            left: 0;
            background-color: var(--color-primary); 
            background-image: linear-gradient(to bottom, var(--color-primary), var(--color-dark-pink)); 
            overflow-x: hidden;
            transition: 0.3s ease-in-out; 
            padding-top: 20px; 
            box-shadow: 4px 0 8px rgba(0,0,0,0.25);
            display: flex;
            flex-direction: column;
        }
        .sidebar-nav.open {
            width: 260px; 
        }
        .sidebar-nav-header { 
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px; 
            border-bottom: 1px solid var(--color-dark-pink); 
            margin-bottom: 10px;
        }
        .sidebar-nav-header .sidebar-title {
            color: var(--bg-white);
            font-size: 1.8em;
            font-weight: 700;
            margin:0;
        }
        .sidebar-nav .close-btn { 
            font-size: 2.2rem; 
            font-weight: 700;
            color: var(--color-text-light); 
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px; 
        }
        .sidebar-nav .close-btn:hover {
            color: var(--color-secondary); 
        }
        .sidebar-nav-links {
            flex-grow: 1;
            overflow-y: auto; 
        }

        .sidebar-nav a {
            padding: 14px 18px 14px 25px; 
            text-decoration: none;
            font-size: 1.15rem; 
            font-weight: 500; 
            color: var(--color-text-light); 
            display: flex; 
            align-items: center; 
            transition: 0.2s ease-in-out;
            border-bottom: 1px solid var(--color-dark-pink); 
        }
        .sidebar-nav a svg { 
            margin-right: 12px; 
            width: 20px;
            height: 20px;
            vertical-align: middle; 
            fill: none; 
            stroke: currentColor; 
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .sidebar-nav-links a:last-child { 
            border-bottom: none; 
        }
        .sidebar-nav a:hover,
        .sidebar-nav a.active {
            color: var(--color-primary); 
            background-color: var(--color-secondary); 
            font-weight: 600;
        }
        .sidebar-nav a:hover svg,
        .sidebar-nav a.active svg {
            stroke: var(--color-primary); 
        }


        /* Conteúdo Principal */
        main { 
            flex-grow: 1; 
            padding: 1.8rem 1.2rem; 
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            box-sizing: border-box;
            transition: margin-left 0.3s ease-in-out; 
        }
        body.sidebar-open main {
             /* Mantém sem margin-left para sobreposição em mobile */
        }

        .page-content { 
             transition: opacity 0.4s ease-in-out;
        }
        .page-content.exiting {
            opacity: 0;
        }
        .page-title {
            color: var(--color-primary); 
            border-bottom: 4px solid var(--color-secondary); 
            padding-bottom: 0.8rem;
            margin-top: 0;
            margin-bottom: 1.8rem; 
            font-size: 2rem; 
            font-weight: 600; 
        }
        .sub-page-title { 
            color: var(--color-primary); 
            font-size: 1.6rem;
            font-weight: 600;
            margin-top: 0;
            margin-bottom: 1.2rem;
        }

        /* Rodapé */
        footer {
            background-color: var(--bg-footer); 
            color: #575355; 
            text-align: center;
            padding: 1.5rem;
            font-size: 0.9rem;
            border-top: 1px solid #e7d8de; 
        }

        /* Estilos para esconder/mostrar páginas */
        .page-content:not(.active) {
            display: none;
        }

        /* Overlay */
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(50,10,30,0.5); 
            z-index: 1000; 
            transition: opacity 0.3s ease-in-out;
        }
        .overlay.active {
            display: block;
        }

        /* ======= ESTILOS DO DASHBOARD ======= */
        #dashboard-page .cards-grid {
            display: grid;
            gap: 12px;
            grid-template-columns: 1fr;
        }
        @media(min-width: 768px) {
            #dashboard-page .cards-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
         @media(min-width: 1024px) {
            #dashboard-page .cards-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        .dashboard-card {
            background-color: var(--bg-white);
            border-radius: var(--border-radius-lg);
            padding: 16px;
            box-shadow: var(--box-shadow-md);
            display: flex;
            align-items: center;
            gap: 12px;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            touch-action: manipulation;
        }
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--box-shadow-lg);
        }
        .dashboard-card:active {
            transform: translateY(0);
        }

        .dashboard-card-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .dashboard-card-icon svg {
            width: 24px;
            height: 24px;
            color: var(--bg-white);
        }
        .icon-bg-pink { background-color: var(--color-primary); }
        .icon-bg-green { background-color: #10b981; }
        .icon-bg-red { background-color: #ef4444; }
        .icon-bg-yellow { background-color: var(--color-secondary); }

        .dashboard-card-content h4 {
            margin: 0 0 0.25rem 0;
            font-size: 16px;
            font-weight: 500;
            color: var(--color-text-primary);
        }
        .dashboard-card-content p {
            margin: 0;
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--color-text-dark);
        }
        
        .dashboard-list-card {
            background-color: var(--bg-white);
            border-radius: var(--border-radius-lg);
            padding: 16px;
            box-shadow: var(--box-shadow-md);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            touch-action: manipulation;
        }
        .dashboard-list-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--box-shadow-lg);
        }
         .dashboard-list-card:active {
            transform: translateY(0);
        }

         .dashboard-list-card h3 {
            margin-top: 0;
            margin-bottom: 1rem;
            font-size: 18px;
            font-weight: 600;
            color: var(--color-primary);
        }
         .dashboard-list-card ul {
            list-style: none;
            padding: 0;
            margin: 0;
         }
         .dashboard-list-card li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0.25rem;
            border-bottom: 1px solid var(--color-text-light);
            font-size: 13px; /* Bullet points */
            color: var(--color-text-secondary); /* Melhor contraste para bullets */
         }
        .dashboard-list-card li:last-child {
            border-bottom: none;
        }
         .dashboard-list-card li strong {
            font-weight: 600;
            color: var(--color-primary);
         }
         .dashboard-list-card .placeholder {
            text-align: center;
            padding: 1rem;
            color: #9ca3af;
         }
        
        .dashboard-summary-grid {
            display: grid;
            gap: 12px;
            grid-template-columns: 1fr;
            margin-top: 1.5rem;
        }
        @media(min-width: 768px) {
             .dashboard-summary-grid {
                grid-template-columns: repeat(2, 1fr);
             }
        }
        
        #goals-progress-card li {
            flex-direction: column;
            align-items: stretch;
        }
        .goal-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-sm);
            font-size: 14px; /* Descrições */
            color: var(--color-text-secondary);
            line-height: 1.5;
        }
        .goal-info .goal-percentage {
            font-weight: 700;
            color: var(--color-primary);
        }
        .progress-bar-container {
            width: 100%;
            height: 12px;
            background-color: #e2e8f0;
            border-radius: 6px;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            width: 0%; 
            background-image: linear-gradient(to right, var(--color-primary), var(--color-secondary));
            border-radius: 6px;
            transition: width 0.5s ease-in-out;
        }


        .quick-actions {
            display: flex;
            gap: 0.9rem;
            margin-top: 2rem;
            flex-wrap: wrap; 
            justify-content: center;
        }
        
        .btn, 
        .btn-action {
            background-color: var(--color-secondary); 
            color: #5c3c00; 
            border: none;
            padding: 0.7rem 1.2rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem; 
            font-weight: 600; 
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
            box-shadow: var(--box-shadow-sm);
            text-decoration: none; 
            display: inline-flex; 
            align-items: center;
            justify-content: center;
            min-height: 44px; 
        }
        .btn:hover,
        .btn-action:hover {
            background-color: #faca50; 
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
         .btn:focus-visible, .btn-action:focus-visible {
            outline: 2px solid var(--color-primary);
            outline-offset: 2px;
        }
        .btn:active,
        .btn-action:active {
            transform: translateY(0px);
            box-shadow: var(--box-shadow-sm);
        }
        .btn-primary { 
            background-color: var(--color-primary);
            color: white;
        }
        .btn-primary:hover {
            background-color: var(--color-dark-pink);
        }
        .btn-secondary { 
            background-color: #e2e8f0; 
            color: #475569; 
        }
        .btn-secondary:hover {
            background-color: #cbd5e1; 
        }
        .btn-danger { 
            background-color: #ef4444; 
            color: white;
        }
        .btn-danger:hover {
            background-color: #dc2626; 
        }
        .btn-sm { 
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
            min-height: auto;
        }

        /* Estilos para Formulários (Genérico) */
        .form-group {
            margin-bottom: 1.2rem;
            position: relative;
        }
        .form-group label {
            display: block;
            font-weight: 500;
            color: var(--color-text-secondary); 
            margin-bottom: 0.4rem;
        }
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db; 
            border-radius: 6px;
            box-sizing: border-box; 
            font-size: 1rem;
            color: var(--color-text-primary); 
            transition: border-color 0.2s;
        }
        .form-group input.is-invalid, .form-group select.is-invalid {
            border-color: #ef4444;
        }
        .form-group input.is-valid, .form-group select.is-valid {
            border-color: #10b981;
        }
        .validation-message {
            font-size: 0.8rem;
            color: #ef4444;
            display: none;
            margin-top: 0.25rem;
        }

        .form-group input[type="file"] {
            padding: 0.5rem; 
        }
        .form-group input[type="checkbox"] { 
            margin-right: 0.5rem;
            vertical-align: middle;
        }
        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end; 
            margin-top: 1.5rem;
        }
        .image-preview {
            width: 150px; 
            height: 150px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            margin-top: 0.5rem;
            display: none; 
            object-fit: cover;
        }

        .status-badge { 
            padding: 0.25rem 0.6rem;
            border-radius: 12px; 
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: capitalize;
        }
        .status-pago { background-color: #dcfce7; color: #166534; } 
        .status-pendente { background-color: #ffedd5; color: #9a3412; } 
        .status-cancelado { background-color: #fee2e2; color: #991b1b; } 

        .form-container { 
            background-color: var(--bg-white);
            padding: 2rem;
            border-radius: 8px;
            box-shadow: var(--box-shadow-md);
            margin-top: 1.5rem;
        }
        
        /* Página de Vendas Específico */
        #form-nova-venda-container .sale-items-list {
            margin-top: 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            min-height: 50px; 
        }
        #form-nova-venda-container .sale-items-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e2e8f0;
        }
        #form-nova-venda-container .sale-items-list li:last-child {
            border-bottom: none;
        }
        #form-nova-venda-container .sale-item-details {
            flex-grow: 1;
        }
        #form-nova-venda-container .sale-item-details strong {
            color: var(--color-primary);
        }
        #form-nova-venda-container .sale-item-actions button {
            background: none;
            border: none;
            color: #ef4444; 
            cursor: pointer;
            padding: 0.25rem;
        }
        #form-nova-venda-container .sale-item-actions button:hover {
            color: #b91c1c;
        }
        #sale-summary {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 2px dashed #fbcfe8;
        }
        #sale-summary p {
            display: flex;
            justify-content: space-between;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: var(--color-text-secondary);
        }
        #sale-summary p.total {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--color-primary);
        }
        .summary-section { 
            margin-top: 2rem;
            padding: 1.5rem;
            background-color: #fff1f2; 
            border-radius: 8px;
            border: 1px solid #ffe4e6;
        }
        .summary-section h4 {
            margin-top: 0;
            color: #9d174d;
        }

        /* ======= PÁGINA DE DESPESAS ======= */
        .despesas-cards-container {
            display: grid;
            gap: 12px;
            grid-template-columns: 1fr; 
        }
        @media (min-width: 768px) {
            .despesas-cards-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        .card-despesa {
            background-color: #fff1f2; 
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.07);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            touch-action: manipulation;
        }
         .card-despesa:hover {
            transform: translateY(-5px);
            box-shadow: var(--box-shadow-lg);
        }
         .card-despesa:active {
            transform: translateY(0);
        }
        .card-despesa-title {
            color: var(--color-primary);
            font-size: 18px; /* Títulos dos cards */
            font-weight: 600; /* Títulos dos cards */
            margin-top: 0;
            margin-bottom: 0.75rem;
            border-bottom: 2px solid var(--color-secondary);
            padding-bottom: 0.5rem;
        }
        .informativo {
            font-size: 14px; /* Descrições */
            color: var(--color-text-secondary);
            line-height: 1.5; /* Descrições */
            margin-bottom: 1.5rem;
            background-color: var(--bg-soft-pink);
            padding: 0.75rem;
            border-radius: 4px;
            border-left: 3px solid var(--color-secondary);
        }
        .card-despesa .form-group { 
             margin-bottom: 1rem;
        }
        .card-despesa .form-actions {
             justify-content: flex-start; 
             margin-top: 1rem;
        }
        .custos-lista {
            list-style: none;
            padding: 0;
            margin-top: 1rem;
            max-height: 180px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
        }
        .custos-lista li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e2e8f0;
            font-size: 13px; /* Bullet points */
        }
        .custos-lista li:last-child {
            border-bottom: none;
        }
        .custos-lista li .cost-details {
            flex-grow: 1;
        }
        .custos-lista li .cost-name {
            font-weight: 500;
            color: var(--color-text-secondary);
        }
         .custos-lista li .cost-unit { 
             font-size: 13px; /* Bullet points */
             color: var(--color-text-secondary);
             display: block;
         }
        .custos-lista li .cost-value {
            color: #166534; 
            font-weight: 500;
        }
        
        .custos-lista li .remove-cost-btn {
            background: none;
            border: none;
            color: #ef4444;
            cursor: pointer;
            padding: 0.25rem;
            margin-left: 1rem;
        }
        .custos-lista li .remove-cost-btn:hover {
            color: #b91c1c;
        }
        .despesas-summary-container {
            margin-top: 2.5rem;
            background-color: var(--bg-white);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: var(--box-shadow-md);
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
            align-items: center;
        }
         @media (min-width: 768px) {
             .despesas-summary-container {
                 grid-template-columns: 1fr 1fr;
             }
         }
        
        .summary-buttons-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .summary-button {
            background-color: var(--bg-soft-pink);
            border: 1px solid #fbcfe8;
            border-radius: 8px;
            padding: 1rem 1.25rem;
            text-align: center;
        }
        .summary-button .label {
            font-size: 16px; /* Subtítulos */
            font-weight: 500;
            color: var(--color-text-primary);
            margin: 0 0 0.5rem 0;
        }
        .summary-button .value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--color-dark-pink);
        }
        .summary-button.primary {
            background-color: var(--color-primary);
            border-color: var(--color-dark-pink);
        }
        .summary-button.primary .label {
             color: var(--color-text-light);
        }
        .summary-button.primary .value {
             color: var(--bg-white);
        }
        .despesas-chart-container {
            position: relative;
            height: 250px;
            width: 100%;
            max-width: 300px; 
            margin: 0 auto;
        }
        
        /* ======= PÁGINA DE PRODUTOS E VENDAS ======= */
        #produtos-page .page-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        .item-cards-container { 
            display: grid;
            gap: 12px;
            margin-top: 1.5rem;
            grid-template-columns: 1fr;
        }
        @media (min-width: 768px) { 
             .item-cards-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media (min-width: 1024px) { 
             .item-cards-container {
                grid-template-columns: repeat(3, 1fr);
            }
        }


        .product-card, .sale-card { 
            background-color: var(--bg-white);
            border-radius: var(--border-radius-md);
            box-shadow: var(--box-shadow-md);
            padding: 16px;
            display: flex;
            flex-direction: column;
            border-left: 5px solid var(--color-secondary); 
            font-size: 0.9rem;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            touch-action: manipulation;
        }
        .product-card:hover, .sale-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--box-shadow-lg);
        }
         .product-card:active, .sale-card:active {
            transform: translateY(0);
        }

        .product-card-image {
            width: 100%;
            aspect-ratio: 1 / 1; 
            object-fit: cover;
            border-radius: 6px;
            margin-bottom: 0.75rem;
        }
        .product-card h4, .sale-card h4 {
            font-size: 18px; /* Títulos dos cards */
            font-weight: 600; /* Títulos dos cards */
            color: var(--color-primary);
            margin: 0 0 0.4rem 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .product-card p, .sale-card p {
            font-size: 14px; /* Descrições */
            color: var(--color-text-secondary);
            margin: 0.2rem 0;
            line-height: 1.5; /* Descrições */
        }
        .product-card p strong, .sale-card p strong {
            color: var(--color-text-primary);
        }
        .product-card p a.link-definir-preco {
            color: var(--color-dark-pink);
            font-weight: 600;
            text-decoration: none;
        }
         .product-card p a.link-definir-preco:hover {
            text-decoration: underline;
         }
        .product-card .actions-cell, .sale-card .actions-cell { 
            margin-top: auto; 
            padding-top: 0.5rem;
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }
         .sale-card .status-badge { 
            display: inline-block; 
            margin-top: 0.5rem;
        }

        /* ======= FORMULÁRIO DE PRODUTO ======= */
        .cost-display-badge {
            background-color: var(--color-text-light);
            border: 1px solid #fbcfe8;
            color: #9d174d;
            padding: 0.5rem 0.8rem;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 1rem;
            text-align: center;
        }
        .cost-display-badge span {
            font-weight: 700;
        }

        #form-pricing-calculator {
            border-top: 2px dashed #fbcfe8;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
        }

        .price-slider-group input[type="range"] {
            flex-grow: 1;
            -webkit-appearance: none;
            width: 100%;
            height: 10px;
            background: #fbcfe8;
            border-radius: 5px;
            outline: none;
            opacity: 0.8;
            transition: opacity .2s;
        }
        .price-slider-group input[type="range"]:hover {
            opacity: 1;
        }
        .price-slider-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 22px;
            height: 22px;
            background: var(--color-primary);
            cursor: pointer;
            border-radius: 50%;
        }
        .price-slider-group input[type="range"]::-moz-range-thumb {
            width: 22px;
            height: 22px;
            background: var(--color-primary);
            cursor: pointer;
            border-radius: 50%;
        }

        .pricing-result {
            background-color: var(--bg-soft-pink);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            margin-top: 1rem;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        .pricing-result div p {
            margin: 0;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--color-text-secondary);
        }
         .pricing-result div .suggested-price {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--color-primary); 
        }
         .pricing-result div .profit-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: #10b981; 
        }
        
        /* ======= IMPORTAÇÃO DE PRODUTOS ======= */
        #import-preview-table-container {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 1rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
        }
        #import-preview-table {
            width: 100%;
            border-collapse: collapse;
        }
        #import-preview-table th, #import-preview-table td {
            padding: 0.6rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.9rem;
        }
        #import-preview-table th {
            background-color: #f9fafb;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        #import-preview-table tr.invalid-row {
            background-color: #fee2e2;
            color: #991b1b;
        }
        #import-preview-table tr.invalid-row td:last-child::after {
            content: ' (Inválido)';
            font-weight: bold;
        }

        /* ======= PÁGINA DE CLIENTES (CRM) ======= */
        .customer-cards-container {
            display: grid;
            gap: 12px;
            grid-template-columns: 1fr;
        }
        @media (min-width: 768px) { 
            .customer-cards-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media (min-width: 1024px) { 
             .customer-cards-container {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .customer-card {
            background-color: #fff;
            border-radius: var(--border-radius-md);
            padding: 16px;
            box-shadow: var(--box-shadow-md);
            border-left: 5px solid var(--color-primary);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            touch-action: manipulation;
        }
        .customer-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--box-shadow-lg);
        }
         .customer-card:active {
            transform: translateY(0);
        }
        .customer-card.dormant {
            border-left-color: #f59e0b; 
        }
        .customer-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        .customer-card-header h4 {
            margin: 0;
            font-size: 18px; /* Títulos dos cards */
            font-weight: 600; /* Títulos dos cards */
            color: var(--color-primary);
        }
        .customer-card-header p {
             margin: 0;
             font-size: 14px; /* Descrições */
             color: var(--color-text-secondary);
             line-height: 1.5;
        }
        .customer-card-info p {
            font-size: 14px; /* Descrições */
            margin: 0.25rem 0;
            color: var(--color-text-secondary);
            line-height: 1.5;
        }
         .customer-card-info p strong {
             color: var(--color-text-primary);
         }
        .last-purchase-title {
            font-size: 16px; /* Subtítulos */
            font-weight: 500; /* Subtítulos */
            color: var(--color-primary);
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        .last-purchase-list {
            list-style: none;
            padding: 0;
            margin: 0;
            font-size: 13px; /* Bullet points */
            color: var(--color-text-secondary);
        }
        .last-purchase-list li {
            padding: 0.2rem 0;
            border: none;
        }

        /* ESTILOS LUCRO CERTO E LIBERDADE FINANCEIRA */
        .main-content-grid {
            display: grid;
            gap: 12px;
            grid-template-columns: 1fr;
        }
        @media(min-width: 992px) {
            .main-content-grid {
                grid-template-columns: repeat(2, 1fr);
                align-items: flex-start;
            }
        }
        
        .lucro-card {
            background-color: var(--bg-white);
            border-radius: var(--border-radius-md);
            padding: 16px;
            box-shadow: var(--box-shadow-md);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            touch-action: manipulation;
        }
        .lucro-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--box-shadow-lg);
        }
         .lucro-card:active {
            transform: translateY(0);
        }
         .lucro-card h3 {
            color: var(--color-primary); 
            font-size: 18px; /* Títulos dos cards */
            font-weight: 600; /* Títulos dos cards */
            margin-top: 0;
            margin-bottom: 1rem;
            border-bottom: 1px solid #fbcfe8;
            padding-bottom: 0.5rem;
        }
        
        .lucro-info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.8rem;
            font-size: 14px; /* Descrições */
            line-height: 1.5;
        }
         .lucro-info-item .label-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .lucro-info-item strong {
            font-weight: 600;
            color: var(--color-primary);
        }

        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }

        .tooltip .tooltip-icon {
            background-color: #e2e8f0;
            color: #475569;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            width: 220px;
            background-color: var(--color-text-primary);
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.85rem;
            font-weight: 400;
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .slider-group {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .slider-group input[type="range"] {
            flex-grow: 1;
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: #fbcfe8;
            border-radius: 5px;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }
        .slider-group input[type="range"]:hover {
            opacity: 1;
        }
        .slider-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--color-primary);
            cursor: pointer;
            border-radius: 50%;
        }
        .slider-group input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--color-primary);
            cursor: pointer;
            border-radius: 50%;
        }
        .slider-group input[type="number"] {
            width: 80px;
            text-align: center;
        }

        .lucro-result-display {
            background-color: var(--bg-soft-pink);
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            margin-top: 1.5rem;
        }

        .lucro-result-display p {
            margin: 0 0 0.5rem 0;
            font-size: 1.1rem;
            color: var(--color-text-secondary);
        }
         .lucro-result-display .destaque-preco {
            font-size: 2rem;
            font-weight: 700;
            color: var(--color-primary); 
        }
         .lucro-result-display .destaque-lucro {
            font-size: 1.2rem;
            font-weight: 700;
            color: #16a34a; 
        }

        #lucro-chart-container {
            position: relative;
            height: 280px;
            width: 100%;
        }

         .lucro-certo-alert {
            padding: 0.75rem 1rem;
            margin-top: 1rem;
            border-radius: 6px;
            font-size: 0.9rem;
            border: 1px solid transparent;
            display: none; /* Inicia escondido */
        }
        .alert-warning { 
            background-color: #fffbeb;
            color: #b45309;
            border-color: #fde68a;
        }
        #plan-ai-assistant {
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: var(--bg-soft-pink);
            border: 1px dashed #fbcfe8;
            border-radius: 8px;
            text-align: center;
        }
        #plan-ai-assistant p {
            margin: 0 0 1rem 0;
            color: var(--color-text-secondary);
            font-weight: 500;
        }

        /* ======= PÁGINA LIBERDADE FINANCEIRA ======= */
        .lf-summary-grid {
            display: grid;
            gap: 12px;
            grid-template-columns: 1fr;
            margin-bottom: 2rem;
        }
        @media(min-width: 768px) {
            .lf-summary-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        #liberdade-financeira-page .debt-cards-container {
            display: grid;
            gap: 12px;
            grid-template-columns: 1fr;
        }
         @media (min-width: 768px) { 
            #liberdade-financeira-page .debt-cards-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media (min-width: 1024px) { 
             #liberdade-financeira-page .debt-cards-container {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .debt-card {
            background-color: #fff;
            border-radius: var(--border-radius-md);
            box-shadow: var(--box-shadow-md);
            padding: 16px;
            border-left: 5px solid;
            display: flex;
            flex-direction: column;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            touch-action: manipulation;
        }
        .debt-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--box-shadow-lg);
        }
        .debt-card:active {
            transform: translateY(0);
        }

        .debt-card.prioridade-alta { border-color: #ef4444; }
        .debt-card.prioridade-media { border-color: #f59e0b; }
        .debt-card.prioridade-baixa { border-color: #10b981; }

        .debt-card h4 {
            font-size: 18px; /* Títulos dos cards */
            font-weight: 600; /* Títulos dos cards */
            color: var(--color-primary);
            margin: 0 0 0.5rem 0;
        }

        .debt-card p {
            margin: 0.25rem 0;
            font-size: 14px; /* Descrições */
            color: var(--color-text-secondary);
            line-height: 1.5;
        }

        .debt-card .debt-actions {
            margin-top: auto;
            padding-top: 1rem;
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        .readonly-field {
            background-color: #f3f4f6;
            cursor: not-allowed;
        }

        /* ======= PÁGINA METAS ======= */
        #goals-container {
            display: grid;
            gap: 12px;
            grid-template-columns: 1fr; 
        }
        @media(min-width: 768px) { 
            #goals-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media(min-width: 1024px) { 
            #goals-container {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        .goal-card {
            background-color: var(--bg-white);
            border-radius: var(--border-radius-lg);
            padding: 16px;
            box-shadow: var(--box-shadow-md);
            text-align: center;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            touch-action: manipulation;
        }
         .goal-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--box-shadow-lg);
        }
         .goal-card:active {
            transform: translateY(0);
        }
        .goal-card h3 {
            color: var(--color-primary);
            font-size: 18px; /* Títulos dos cards */
            font-weight: 600; /* Títulos dos cards */
            margin-top: 0;
            margin-bottom: 1rem;
        }
        .goal-chart-container {
            position: relative;
            width: 150px;
            height: 150px;
            margin: 0 auto 1rem auto;
        }
        .goal-card .form-group {
            margin-bottom: 0.5rem;
        }
        .goal-card input {
            text-align: center;
            font-weight: 600;
            color: var(--color-primary);
        }
        
        .toast-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #2d3748;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 2000;
            transform: translateX(120%);
            transition: transform 0.4s ease-in-out;
        }
        .toast-notification.show {
            transform: translateX(0);
        }
        .toast-notification.success { background-color: #10b981; }
        .toast-notification.error { background-color: #ef4444; }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--color-primary);
            border-right: 4px solid var(--color-secondary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

</head>
<body>
    <div id="app-overlay" class="overlay"></div>

    <aside id="sidebar-nav" class="sidebar-nav">
        <div class="sidebar-nav-header">
            <h2 class="sidebar-title">C4</h2>
            <button class="close-btn" id="close-sidebar-btn" aria-label="Fechar menu">&times;</button>
        </div>
        <div class="sidebar-nav-links">
            <a href="#dashboard" class="sidebar-nav-item active" data-page="dashboard-page">
                <svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                Dashboard
            </a>
            <a href="#despesas" class="sidebar-nav-item" data-page="despesas-page">
                <svg viewBox="0 0 24 24"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
                Despesas
            </a>
            <a href="#produtos" class="sidebar-nav-item" data-page="produtos-page">
                <svg viewBox="0 0 24 24"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path><line x1="3" y1="6" x2="21" y2="6"></line><path d="M16 10a4 4 0 0 1-8 0"></path></svg>
                Produtos
            </a>
            <a href="#vendas" class="sidebar-nav-item" data-page="vendas-page">
                <svg viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                Vendas
            </a>
            <a href="#clientes" class="sidebar-nav-item" data-page="clientes-page">
                <svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                Clientes
            </a>
            <a href="#liberdade-financeira" class="sidebar-nav-item" data-page="liberdade-financeira-page">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>
                Liberdade Financeira
            </a>
            <a href="#metas" class="sidebar-nav-item" data-page="metas-page">
                <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>
                Metas
            </a>
            <a href="#relatorios" class="sidebar-nav-item" data-page="relatorios-page">
                <svg viewBox="0 0 24 24"><line x1="12" y1="20" x2="12" y2="10"></line><line x1="18" y1="20" x2="18" y2="4"></line><line x1="6" y1="20" x2="6" y2="16"></line></svg>
                Relatórios
            </a>
            <a href="#c4-ia" class="sidebar-nav-item" data-page="c4-ia-page">
                <svg viewBox="0 0 24 24"><path d="M12 2a10 10 0 0 0-10 10c0 6 8 10 10 10s10-4 10-10A10 10 0 0 0 12 2z"></path><path d="M12 10a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"></path><path d="M12 14a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"></path><path d="M12 18a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"></path></svg>
                C4 IA
            </a>
            <a href="#perfil" class="sidebar-nav-item" data-page="perfil-page"> 
                <svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                Perfil
            </a>
        </div>
    </aside>

    <header class="app-header header-gradient">
        <button class="menu-toggle" id="menu-toggle-btn" aria-label="Abrir menu">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"></path>
            </svg>
        </button>
        <h1 class="app-header-title">C4</h1> 
        <div></div>
    </header>

    <main id="app-content">
        <section id="dashboard-page" class="page-content active">
            <h2 class="page-title">Dashboard</h2>
            
            <div class="cards-grid" id="dashboard-cards-summary">
                <div class="dashboard-card">
                    <div class="dashboard-card-icon icon-bg-pink">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                    </div>
                    <div class="dashboard-card-content">
                        <h4>Receita Bruta (Mês)</h4>
                        <p id="dashboard-receita-bruta">R$ 0,00</p>
                    </div>
                </div>
                <div class="dashboard-card">
                    <div class="dashboard-card-icon icon-bg-green">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                    </div>
                    <div class="dashboard-card-content">
                        <h4>Lucro Líquido (Mês)</h4>
                        <p id="dashboard-lucro-liquido">R$ 0,00</p>
                    </div>
                </div>
                 <div class="dashboard-card">
                    <div class="dashboard-card-icon icon-bg-red">
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                    </div>
                    <div class="dashboard-card-content">
                        <h4>Despesas a Vencer</h4>
                        <p id="dashboard-despesas-vencimento">0</p>
                    </div>
                </div>
                <div class="dashboard-card">
                    <div class="dashboard-card-icon icon-bg-yellow">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                    </div>
                    <div class="dashboard-card-content">
                        <h4>Economia Planejada</h4>
                        <p id="dashboard-economia-planejada">R$ 0,00</p>
                    </div>
                </div>
            </div>

            <div class="dashboard-summary-grid">
                <div class="dashboard-list-card" id="financial-summary-card">
                    <h3>Resumo Financeiro</h3>
                    <ul id="financial-summary-list">
                        <!-- Gerado por JS -->
                    </ul>
                </div>
                <div class="dashboard-list-card" id="top-products-card">
                    <h3>Top 5 Produtos Vendidos</h3>
                    <ul id="top-products-list">
                       <!-- Gerado por JS -->
                    </ul>
                </div>
            </div>
            
            <div class="dashboard-list-card" id="goals-progress-card">
                <h3>Progresso das Metas</h3>
                <ul id="dashboard-goals-list">
                    <!-- Gerado por JS -->
                </ul>
            </div>

            <div class="dashboard-list-card">
                <h3>Estoque Baixo</h3>
                <ul id="dashboard-lista-estoque-baixo">
                    <!-- Gerado por JS -->
                </ul>
            </div>

            <div class="quick-actions">
                <button class="btn-action" data-target-page="vendas-page">Nova Venda</button>
                <button class="btn-action" data-target-page="produtos-page">Novo Produto</button>
            </div>
        </section>

        <section id="produtos-page" class="page-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
                <h2 class="page-title" style="margin-bottom: 0;">Produtos</h2>
                <div class="page-actions">
                    <button class="btn btn-secondary" id="btn-show-import-product-form">
                         <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                        Importar Planilha
                    </button>
                    <button class="btn btn-primary" id="btn-show-add-product-form">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        Cadastro Manual
                    </button>
                </div>
            </div>

            <!-- Formulário de Cadastro Manual -->
            <div id="form-cadastro-produto-container" class="form-container" style="display: none; max-width: 600px; margin-left:auto; margin-right: auto;">
                <h3 style="color: #db1472; font-weight: 600; margin-top:0; margin-bottom: 1.5rem;">Cadastro Manual de Produto</h3>
                <form id="form-cadastro-produto">
                    <input type="hidden" id="produto-id-edit" value="">
                    <div class="form-group">
                        <label for="produto-nome">Nome do Produto</label>
                        <input type="text" id="produto-nome" name="produto-nome" required>
                    </div>
                    <div class="form-group">
                        <label for="produto-categoria">Categoria</label>
                        <select id="produto-categoria" name="produto-categoria">
                            <option value="">Selecione</option>
                            <option value="calcados">Calçados</option>
                            <option value="roupas">Roupas</option>
                            <option value="bolsas">Bolsas</option>
                            <option value="perfumaria">Perfumaria</option>
                            <option value="maquiagem">Maquiagem</option>
                            <option value="skin_care">Skin Care</option>
                            <option value="acessorios">Acessórios</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="produto-valor-custo">Preço de Custo (R$)</label>
                        <input type="number" id="produto-valor-custo" name="produto-valor-custo" step="0.01" min="0" required placeholder="0,00">
                    </div>
                    <div class="cost-display-badge">Custo Unitário de Despesas: <span id="produto-custo-unitario-despesas">R$ 0,00</span></div>

                    <div id="form-pricing-calculator">
                        <div class="form-group">
                            <label for="produto-margem-lucro-slider">Margem de Lucro Desejada (<span id="produto-margem-lucro-label">100</span>%)</label>
                            <div class="price-slider-group">
                                <input type="range" id="produto-margem-lucro-slider" min="10" max="300" value="100" step="1">
                            </div>
                        </div>
                        <div class="pricing-result">
                            <div>
                                <p>Preço de Venda</p>
                                <p class="suggested-price" id="produto-preco-sugerido">R$ 0,00</p>
                            </div>
                             <div>
                                <p>Lucro por Venda</p>
                                <p class="profit-value" id="produto-lucro-estimado">R$ 0,00</p>
                            </div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top:1.5rem;">
                        <div class="form-group">
                            <label for="produto-estoque">Quantidade em Estoque</label>
                            <input type="number" id="produto-estoque" name="produto-estoque" step="1" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="produto-imagem">Imagem do Produto</label>
                            <input type="file" id="produto-imagem" name="produto-imagem" accept="image/*">
                        </div>
                    </div>
                    <img id="produto-imagem-preview" class="image-preview" src="#" alt="Pré-visualização da imagem">
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="btn-cancel-add-product">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Salvar Produto</button>
                    </div>
                </form>
            </div>

            <!-- Seção de Importação de Planilha -->
            <div id="form-importar-planilha-container" class="form-container" style="display: none;">
                 <h3 style="color: #db1472; font-weight: 600; margin-top:0; margin-bottom: 1.5rem;">Importar Produtos via Planilha</h3>
                 <p class="informativo">Para importar, sua planilha (formato .CSV) deve conter as seguintes colunas, nesta ordem: <code>Nome,Categoria,PrecoCusto,Estoque</code>.</p>
                 <a href="#" id="download-csv-template" class="btn btn-sm btn-secondary" style="margin-bottom: 1.5rem;">Baixar Modelo de Planilha (.csv)</a>
                 <div class="form-group">
                     <label for="import-csv-file">Selecione o arquivo .CSV</label>
                     <input type="file" id="import-csv-file" accept=".csv">
                 </div>
                 <div id="import-preview-container"></div>
                 <div class="form-actions" id="import-actions" style="display:none;">
                     <button class="btn btn-secondary" id="btn-cancel-import">Cancelar</button>
                     <button class="btn btn-primary" id="btn-confirm-import">Confirmar Importação</button>
                 </div>
            </div>

            <h3 style="color: #db1472; font-weight: 500; margin-top: 2rem;">Meus Produtos</h3>
            <div class="item-cards-container" id="product-cards-list">
            </div>
            <p id="no-products-message" style="text-align: center; color: #6b7280; padding: 1rem; display: none;">Nenhum produto cadastrado ainda.</p>
        </section>

        <section id="vendas-page" class="page-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
                <h2 class="page-title" style="margin-bottom: 0;">Vendas</h2>
                <button class="btn btn-primary" id="btn-show-nova-venda-form">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    Nova Venda
                </button>
            </div>
            <div id="form-nova-venda-container" class="form-container" style="display: none;">
                <h3 style="color: #db1472; font-weight: 600; margin-top:0; margin-bottom: 1.5rem;">Registar Nova Venda</h3>
                <form id="form-nova-venda">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                        <div class="form-group">
                            <label for="venda-cliente">Nome do Cliente</label>
                            <input type="text" id="venda-cliente" name="venda-cliente" placeholder="Nome do cliente" required>
                        </div>
                        <div class="form-group">
                            <label for="venda-cliente-telefone">Telefone do Cliente</label>
                            <input type="tel" id="venda-cliente-telefone" name="venda-cliente-telefone" placeholder="(99) 99999-9999">
                        </div>
                    </div>
                    <fieldset style="border: 1px solid #e2e8f0; border-radius: 6px; padding: 1rem; margin-bottom: 1.5rem;">
                        <legend style="color: #666666; font-weight:500; padding: 0 0.5rem;">Adicionar Produtos</legend>
                        <div style="display: flex; gap: 1rem; align-items: flex-end; margin-bottom:1rem;">
                            <div class="form-group" style="flex-grow:3; margin-bottom:0;">
                                <label for="venda-produto-select">Produto</label>
                                <select id="venda-produto-select" name="venda-produto-select">
                                    <option value="">Selecione um produto</option>
                                </select>
                            </div>
                            <div class="form-group" style="flex-grow:1; margin-bottom:0;">
                                <label for="venda-produto-qtd">Qtd.</label>
                                <input type="number" id="venda-produto-qtd" name="venda-produto-qtd" min="1" value="1" style="width: 70px;">
                            </div>
                            <button type="button" class="btn btn-secondary" id="btn-add-produto-venda" style="padding: 0.7rem;">Adicionar</button>
                        </div>
                        <h4 style="color:#db1472; font-weight:500; margin-top:1.5rem; margin-bottom:0.5rem;">Itens da Venda:</h4>
                        <ul id="venda-itens-lista" class="sale-items-list" style="list-style: none; padding:0;">
                             <p id="venda-sem-itens" style="text-align: center; color: #6b7280; padding: 1rem 0;">Nenhum item adicionado à venda.</p>
                        </ul>
                    </fieldset>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div class="form-group">
                            <label for="venda-desconto">Desconto (%)</label>
                            <input type="number" id="venda-desconto" name="venda-desconto" min="0" max="100" value="0">
                        </div>
                        <div class="form-group">
                            <label for="venda-forma-pagamento">Forma de Pagamento</label>
                            <select id="venda-forma-pagamento" name="venda-forma-pagamento" required>
                                <option value="dinheiro">Dinheiro</option><option value="cartao_debito">Cartão de Débito</option>
                                <option value="cartao_credito">Cartão de Crédito</option><option value="pix">PIX</option>
                                <option value="boleto">Boleto</option>
                            </select>
                        </div>
                    </div>
                    <div id="sale-summary">
                        <p>Subtotal: <span id="venda-subtotal">R$ 0,00</span></p>
                        <p>Desconto (<span id="venda-desconto-perc">0</span>%): <span id="venda-valor-desconto">R$ 0,00</span></p>
                        <p class="total">Total a Pagar: <span id="venda-total-pagar">R$ 0,00</span></p>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="btn-cancel-nova-venda">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Finalizar Venda</button>
                    </div>
                </form>
            </div>
            <h3 style="color: #db1472; font-weight: 500; margin-top: 2rem;">Histórico de Vendas</h3>
            <div class="item-cards-container" id="sales-history-cards-list">
            </div>
             <p id="no-vendas-message" style="text-align: center; color: #6b7280; padding: 1rem; display: none;">Nenhuma venda registada ainda.</p>
        </section>

        <section id="clientes-page" class="page-content">
            <h2 class="page-title">Gestão de Clientes (CRM)</h2>
            <p class="informativo">Acompanhe seus clientes, veja o histórico de compras e identifique novas oportunidades de venda.</p>
            <div id="customer-cards-container" class="customer-cards-container">
                <!-- Cards de cliente serão gerados aqui -->
            </div>
            <p id="no-customers-message" style="display: none; text-align:center; color: #6b7280; padding: 1.5rem;">Nenhum cliente registrado. Faça uma venda para começar!</p>
        </section>
        
        <section id="despesas-page" class="page-content">
            <h2 class="page-title">Controle de Despesas</h2>
            <div class="despesas-cards-container">
                <!-- Card Custos Fixos -->
                <div class="card-despesa" id="card-custos-fixos">
                    <h3 class="card-despesa-title">🧾 Custos Fixos</h3>
                    <p class="informativo">Custos que não mudam com o volume de vendas.</p>
                    <form id="form-add-custo-fixo">
                        <div class="form-group">
                            <label for="custo-fixo-nome">Nome do Custo Fixo</label>
                            <input type="text" id="custo-fixo-nome" placeholder="Ex: Aluguel" required>
                        </div>
                        <div class="form-group">
                            <label for="custo-fixo-valor">Valor Mensal (R$)</label>
                            <input type="number" id="custo-fixo-valor" step="0.01" min="0" placeholder="Ex: 800,00" required>
                        </div>
                        <div class="form-group">
                            <label for="custo-fixo-vencimento">Data de Vencimento</label>
                            <input type="date" id="custo-fixo-vencimento" name="custo-fixo-vencimento" required>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary btn-sm">Adicionar</button>
                        </div>
                    </form>
                    <h4 style="margin-top:1.5rem; color:#db1472;">Custos Cadastrados:</h4>
                    <ul id="lista-custos-fixos" class="custos-lista"></ul>
                </div>

                <!-- Card Custos Variáveis -->
                <div class="card-despesa" id="card-custos-variaveis">
                    <h3 class="card-despesa-title">⚙️ Custos Variáveis</h3>
                    <p class="informativo">Custos por unidade vendida. Ex: embalagem.</p>
                    <form id="form-add-custo-variavel">
                        <div class="form-group">
                            <label for="custo-variavel-nome">Nome do Custo</label>
                            <input type="text" id="custo-variavel-nome" placeholder="Ex: Embalagem" required>
                        </div>
                        <div class="form-group">
                            <label for="custo-variavel-valor-unitario">Valor por Unidade (R$)</label>
                            <input type="number" id="custo-variavel-valor-unitario" step="0.01" min="0" placeholder="Ex: 2,50" required>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary btn-sm">Adicionar</button>
                        </div>
                    </form>
                    <h4 style="margin-top:1.5rem; color:#db1472;">Custos Cadastrados:</h4>
                    <ul id="lista-custos-variaveis" class="custos-lista"></ul>
                </div>

                <!-- NOVO Card Custo de Frete -->
                <div class="card-despesa" id="card-custo-frete">
                    <h3 class="card-despesa-title">🚚 Custo de Frete</h3>
                    <p class="informativo">Rateio do frete de compra por unidade.</p>
                    <form id="form-add-custo-frete">
                        <div class="form-group">
                            <label for="frete-valor-total">Valor Total do Frete (R$)</label>
                            <input type="number" id="frete-valor-total" step="0.01" min="0" placeholder="Ex: 150,00" required>
                        </div>
                         <div class="form-group">
                            <label for="frete-quantidade-pecas">Quantidade de Peças</label>
                            <input type="number" id="frete-quantidade-pecas" step="1" min="1" placeholder="Ex: 30" required>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary btn-sm">Adicionar</button>
                        </div>
                    </form>
                    <h4 style="margin-top:1.5rem; color:#db1472;">Fretes Cadastrados:</h4>
                    <ul id="lista-custos-frete" class="custos-lista"></ul>
                </div>

                <!-- NOVO Card Custo de Imposto -->
                 <div class="card-despesa" id="card-custo-imposto">
                    <h3 class="card-despesa-title">📊 Custo de Imposto</h3>
                    <p class="informativo">Impostos sobre a venda. Ex: ICMS, Simples.</p>
                    <form id="form-add-custo-imposto">
                        <div class="form-group">
                            <label for="imposto-nome">Nome do Imposto</label>
                            <input type="text" id="imposto-nome" placeholder="Ex: Simples Nacional" required>
                        </div>
                        <div class="form-group">
                            <label for="imposto-valor-percentual">Alíquota (%)</label>
                            <input type="number" id="imposto-valor-percentual" step="0.01" min="0" placeholder="Ex: 4.5" required>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary btn-sm">Adicionar</button>
                        </div>
                    </form>
                    <h4 style="margin-top:1.5rem; color:#db1472;">Impostos Cadastrados:</h4>
                    <ul id="lista-custos-impostos" class="custos-lista"></ul>
                </div>
            </div>

            <!-- NOVA Seção de Resumo e Gráfico -->
            <div class="despesas-summary-container">
                <div class="summary-buttons-container">
                    <div id="summary-total-fixo" class="summary-button">
                        <p class="label">Custo Fixo Total Mensal</p>
                        <p class="value">R$ 0,00</p>
                    </div>
                    <div id="summary-total-unitario" class="summary-button primary">
                        <p class="label">Custo Total por Unidade</p>
                        <p class="value">R$ 0,00</p>
                    </div>
                </div>
                <div class="despesas-chart-container">
                    <canvas id="despesas-pie-chart"></canvas>
                </div>
            </div>

        </section>

        <section id="liberdade-financeira-page" class="page-content">
            <h2 class="page-title">Liberdade Financeira</h2>
             <div class="lf-summary-grid">
                 <div class="summary-button">
                     <p class="label">Total de Dívidas</p>
                     <p class="value" id="lf-total-dividas">R$ 0,00</p>
                 </div>
                  <div class="summary-button">
                     <p class="label">Economia Mensal Planejada</p>
                     <p class="value" id="lf-total-economias">R$ 0,00</p>
                 </div>
             </div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
                <h3 class="sub-page-title" style="margin:0;">Minhas Dívidas</h3>
                 <button class="btn btn-primary" id="btn-show-add-debt-form">
                     <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    Adicionar Dívida
                </button>
            </div>

             <div id="form-add-debt-container" class="form-container" style="display: none;">
                 <h3 class="sub-page-title">Cadastrar Nova Dívida</h3>
                 <form id="form-add-debt">
                    <div class="form-group">
                        <label for="debt-name">Nome da Dívida</label>
                        <input type="text" id="debt-name" placeholder="Ex: Cartão de Crédito" required>
                    </div>
                     <div class="form-group">
                        <label for="debt-value">Valor Total (R$)</label>
                        <input type="number" id="debt-value" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="debt-priority">Prioridade de Pagamento</label>
                        <select id="debt-priority">
                            <option value="baixa">Baixa</option>
                            <option value="media" selected>Média</option>
                            <option value="alta">Alta</option>
                        </select>
                    </div>
                    <div class="form-actions" style="justify-content: flex-start;">
                        <button type="submit" class="btn btn-primary">Adicionar Dívida</button>
                        <button type="button" class="btn btn-secondary" id="btn-cancel-add-debt">Cancelar</button>
                    </div>
                 </form>
            </div>
            
            <div class="debt-cards-container" id="debt-cards-container"></div>
            <p id="no-debts-message" style="text-align: center; color: #6b7280; padding: 1rem; display: none;">Nenhuma dívida cadastrada ainda. Isso é ótimo!</p>
        </section>

        <section id="planejamento-divida-page" class="page-content">
             <button class="btn btn-secondary" id="btn-voltar-dividas" style="margin-bottom: 1.5rem;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                Voltar
            </button>
            <h2 class="page-title" id="planejamento-divida-titulo">Planejar Quitação</h2>
            
            <div class="main-content-grid">
                <div class="lucro-card">
                    <h3>Sua Estratégia de Quitação</h3>
                     <form id="form-planejar-divida">
                        <input type="hidden" id="plan-debt-id">
                         <div class="form-group">
                            <label>Dívida:</label>
                            <input type="text" id="plan-debt-name-display" readonly class="readonly-field">
                        </div>
                         <div class="form-group">
                            <label for="planejar-divida-valor">Quanto você pode poupar?</label>
                            <div style="display: flex; gap: 1rem;">
                                <input type="number" id="planejar-divida-valor" step="0.01" min="1" required placeholder="Ex: 5,00" style="flex-grow: 2;">
                                <select id="planejar-divida-frequencia" class="form-group" style="margin:0; flex-grow: 1;">
                                    <option value="dia">por Dia</option>
                                    <option value="quinzena">por Quinzena</option>
                                    <option value="mes" selected>por Mês</option>
                                </select>
                            </div>
                        </div>
                        <div class="lucro-result-display" style="padding: 1rem; margin-top: 0; margin-bottom: 1.5rem;">
                            <div class="lucro-info-item" style="margin: 0.5rem 0;">
                                <span>Tempo para quitar:</span>
                                <strong id="plan-duration-result">--</strong>
                            </div>
                             <div class="lucro-info-item" style="margin: 0.5rem 0;">
                                <span>Vendas/mês para Atingir a Meta:</span>
                                <strong id="plan-sales-needed-result">--</strong>
                            </div>
                        </div>
                        <p id="plan-motivation-message" class="informativo" style="text-align:center; display:none;"></p>
                        <div class="form-actions" style="justify-content: flex-start; gap: 1rem;">
                            <button type="submit" class="btn btn-primary">Salvar Planejamento</button>
                        </div>
                     </form>
                </div>
                <div id="plan-ai-assistant" class="lucro-card">
                     <h3>✨ Assistente C4 IA</h3>
                     <p>Precisa de ajuda para vender mais e atingir sua meta de economia? Nossa IA pode te dar dicas!</p>
                     <button class="btn btn-primary" data-target-page="c4-ia-page">Pedir Dicas para IA</button>
                </div>
            </div>
        </section>
        
        <section id="lucro-certo-page" class="page-content">
            <h2 class="page-title">🎯 Calculadora de Preço de Venda</h2>
            <div class="form-container">
                 <div class="form-group">
                    <label for="lucro-produto-select">Selecione um Produto para Análise:</label>
                    <select id="lucro-produto-select">
                        <option value="">-- Escolha um Produto --</option>
                    </select>
                </div>
            </div>

            <div id="lucro-certo-content" style="display:none;">
                <div class="main-content-grid">
                    <div class="lucro-card">
                        <h3><span id="lucro-nome-produto-display">Nome do Produto</span></h3>
                        <div class="lucro-info-item">
                            <div class="label-group">
                                <span>Custo Fixo Unitário</span>
                                <div class="tooltip">
                                    <span class="tooltip-icon">?</span>
                                    <span class="tooltip-text">Rateio dos seus custos fixos mensais (aluguel, internet) por uma estimativa de vendas.</span>
                                </div>
                            </div>
                            <strong id="lucro-display-custo-fixo">R$ 0,00</strong>
                        </div>
                         <div class="lucro-info-item">
                             <div class="label-group">
                                <span>Custo Variável Unitário</span>
                                 <div class="tooltip">
                                    <span class="tooltip-icon">?</span>
                                    <span class="tooltip-text">Soma de todos os custos que ocorrem por venda (embalagem, taxas, etc).</span>
                                </div>
                            </div>
                            <strong id="lucro-display-custo-variavel">R$ 0,00</strong>
                        </div>
                        <div class="lucro-info-item">
                            <div class="label-group">
                                <span>Custo de Frete (Estimado)</span>
                                <div class="tooltip">
                                    <span class="tooltip-icon">?</span>
                                    <span class="tooltip-text">Um valor médio de frete por unidade para compor seu custo.</span>
                                </div>
                            </div>
                            <strong id="lucro-display-custo-frete">R$ 0,00</strong>
                        </div>
                         <div class="lucro-info-item">
                            <span>Custo de Compra</span>
                            <strong id="lucro-display-custo-compra">R$ 0,00</strong>
                        </div>
                        <hr style="border:none; border-top: 1px solid #fce7f3; margin: 1rem 0;">
                        <div class="lucro-info-item">
                            <span style="font-weight: bold; color: #500724;">Custo Total do Produto</span>
                            <strong id="lucro-custo-total-display">R$ 0,00</strong>
                        </div>

                        <div class="form-group" style="margin-top: 2rem;">
                            <div class="lucro-info-item">
                                <label for="lucro-margem-slider" class="label-group">
                                    Margem de Lucro Desejada
                                    <div class="tooltip">
                                        <span class="tooltip-icon">?</span>
                                        <span class="tooltip-text">Qual porcentagem do preço de venda será seu lucro.</span>
                                    </div>
                                </label>
                            </div>
                            <div class="slider-group">
                                <input type="range" id="lucro-margem-slider" min="10" max="200" value="100" step="1">
                                <input type="number" id="lucro-margem-input" min="10" max="200" value="100">
                                <span>%</span>
                            </div>
                        </div>

                         <div id="lucro-alerta-margem" class="lucro-certo-alert alert-warning">
                            Atenção! Sua margem de lucro está abaixo de 20%. Considere aumentar o preço ou reduzir custos.
                        </div>

                        <div class="lucro-result-display">
                            <p>Preço de Venda Sugerido</p>
                            <p class="destaque-preco" id="lucro-preco-venda-sugerido">R$ 0,00</p>
                            <p class="destaque-lucro" id="lucro-liquido-unidade">Lucro de R$ 0,00 por unidade</p>
                        </div>

                        <div class="form-actions" style="margin-top: 1.5rem;">
                             <button type="button" class="btn btn-primary" id="btn-salvar-preco-lucro-certo">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:8px;"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                                Salvar Preço no Produto
                            </button>
                        </div>
                    </div>
                    <div class="lucro-card">
                        <h3>Composição do Preço</h3>
                        <div id="lucro-chart-container">
                            <canvas id="lucro-produto-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <p id="lucro-certo-selecione-produto-msg" style="text-align:center; color:#6b7280; padding:1rem;">Selecione um produto para começar.</p>
        </section>

        <section id="metas-page" class="page-content">
            <h2 class="page-title">Minhas Metas de Vendas</h2>
             <div id="goals-container">
                 <!-- Meta Diária -->
                 <div class="goal-card">
                     <h3>Meta Diária</h3>
                     <div class="goal-chart-container">
                         <canvas id="daily-goal-chart"></canvas>
                     </div>
                     <div class="form-group">
                         <label for="daily-goal-input">Definir Meta (R$)</label>
                         <input type="number" id="daily-goal-input" placeholder="R$ 0,00">
                     </div>
                     <button class="btn btn-primary btn-sm save-goal-btn" data-period="daily">Salvar Meta</button>
                 </div>
                 <!-- Meta Semanal -->
                 <div class="goal-card">
                     <h3>Meta Semanal</h3>
                     <div class="goal-chart-container">
                         <canvas id="weekly-goal-chart"></canvas>
                     </div>
                      <div class="form-group">
                         <label for="weekly-goal-input">Definir Meta (R$)</label>
                         <input type="number" id="weekly-goal-input" placeholder="R$ 0,00">
                     </div>
                     <button class="btn btn-primary btn-sm save-goal-btn" data-period="weekly">Salvar Meta</button>
                 </div>
                 <!-- Meta Mensal -->
                 <div class="goal-card">
                     <h3>Meta Mensal</h3>
                     <div class="goal-chart-container">
                         <canvas id="monthly-goal-chart"></canvas>
                     </div>
                      <div class="form-group">
                         <label for="monthly-goal-input">Definir Meta (R$)</label>
                         <input type="number" id="monthly-goal-input" placeholder="R$ 0,00">
                     </div>
                     <button class="btn btn-primary btn-sm save-goal-btn" data-period="monthly">Salvar Meta</button>
                 </div>
             </div>
             <div id="plan-ai-assistant" class="form-container" style="margin-top: 2.5rem;">
                 <h3>✨ Assistente C4 IA</h3>
                 <p>Precisa de um plano para bater suas metas? Nossa IA pode te ajudar a criar estratégias de vendas eficazes!</p>
                 <button class="btn btn-primary" data-target-page="c4-ia-page">Pedir Ajuda para IA</button>
            </div>
        </section>
        
         <section id="relatorios-page" class="page-content">
             <h2 class="page-title">Relatórios</h2>
             <div class="form-container"><p><em>Em breve...</em></p></div>
        </section>
         <section id="c4-ia-page" class="page-content">
             <h2 class="page-title">C4 IA</h2>
             <div class="form-container"><p><em>Em breve...</em></p></div>
        </section>
         <section id="perfil-page" class="page-content">
            <h2 class="page-title">Perfil e Configurações</h2>
             <div class="form-container">
                <h3 class="sub-page-title">Backup e Restauração</h3>
                <p class="informativo">Salve seus dados em um arquivo seguro ou restaure a partir de um backup.</p>
                <div class="form-actions" style="justify-content: flex-start;">
                    <button class="btn btn-secondary" id="btn-export-data">Exportar Dados</button>
                    <input type="file" id="import-file-input" style="display: none;" accept=".json">
                    <button class="btn btn-primary" id="btn-import-data">Importar Dados</button>
                </div>
             </div>
        </section>
    </main>

    <footer class="app-footer">
        <p>&copy; <span id="current-year"></span> C4. Todos os direitos reservados.</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // =================================================================================
            // ======================== CÉREBRO DO APP (STATE MANAGEMENT) ========================
            // =================================================================================
            let appState = {};
            let goalCharts = {};
            let lucroProdutoChartInstance = null;
            let despesasChartInstance = null;
            let produtoSelecionadoLucroCerto = null;
            let itensVendaTemporarios = [];
            let produtosImportadosParaConfirmacao = [];
            const motivationalQuotes = [
                "Cada real guardado é um passo em direção à sua tranquilidade financeira. Continue!",
                "Pequenas economias diárias constroem grandes fortunas. Você está no caminho certo!",
                "Sua disciplina hoje é a sua liberdade amanhã. Força!",
                "Você é mais forte que suas dívidas. Continue planejando e você vencerá!",
                "Imagine a sensação de quitar essa dívida. Mantenha o foco nesse sentimento!"
            ];

            function saveState() {
                try {
                    const serializedState = JSON.stringify(appState);
                    localStorage.setItem('c4AppState', serializedState);
                } catch (error) {
                    console.error("Erro ao salvar dados:", error);
                    showToast("Erro: Não foi possível salvar os dados. O armazenamento pode estar cheio.", "error");
                }
            }

            function loadState() {
                const savedState = localStorage.getItem('c4AppState');
                if (savedState) {
                    try {
                        const parsedState = JSON.parse(savedState);
                        if(parsedState && typeof parsedState === 'object' && parsedState.products && parsedState.expenses){
                             appState = parsedState;
                             if (!appState.expenses.freight) appState.expenses.freight = [];
                             if (!appState.expenses.taxes) appState.expenses.taxes = [];
                             if (!appState.debtPlans) appState.debtPlans = [];
                             if (!appState.goals) appState.goals = { daily: 0, weekly: 0, monthly: 0 };
                        } else {
                            throw new Error("Dados salvos estão corrompidos.");
                        }
                    } catch(e) {
                         console.error("Erro ao carregar dados salvos:", e);
                         showToast("Aviso: Dados anteriores não puderam ser carregados.", "error");
                         loadDefaultState();
                    }
                } else {
                    loadDefaultState();
                }
            }

            function loadDefaultState() {
                 appState = {
                    products: [ 
                        { id: 'prod1', name: 'Bolsa de Couro Caramelo', category: 'bolsas', costPrice: 80.00, salePrice: 249.90, stock: 15, image: 'https://placehold.co/400x400/db1472/ffffff?text=Bolsa' },
                        { id: 'prod2', name: 'Tênis Casual Branco', category: 'calcados', costPrice: 65.00, salePrice: 189.90, stock: 30, image: 'https://placehold.co/400x400/c01062/ffffff?text=Tênis' },
                    ],
                    sales: [],
                    expenses: {
                        fixed: [ { id: 'fix1', name: 'Aluguel do Espaço', value: 800.00, dueDate: '2025-06-10' } ],
                        variable: [ { id: 'var1', name: 'Embalagem de Luxo', unitValue: 2.50 } ],
                        freight: [],
                        taxes: []
                    },
                    debts: [],
                    debtPlans: [],
                    goals: { daily: 0, weekly: 0, monthly: 0 },
                    settings: { 
                        lowStockThreshold: 5,
                        estimatedMonthlySales: 100
                    }
                };
                saveState();
            }

            // =================================================================================
            // ============================= LÓGICA DE NAVEGAÇÃO E SETUP =======================
            // =================================================================================
            
            const sidebarNav = document.getElementById('sidebar-nav');
            const appOverlay = document.getElementById('app-overlay');
            const body = document.body;

            function openSidebar() {
                sidebarNav.classList.add('open');
                appOverlay.classList.add('active');
                body.classList.add('sidebar-open');
            }

            function closeSidebar() {
                sidebarNav.classList.remove('open');
                appOverlay.classList.remove('active');
                body.classList.remove('sidebar-open');
            }

            function setActivePage(pageId, data = null) { 
                const currentPage = document.querySelector('.page-content.active');
                if(currentPage) currentPage.classList.add('exiting');

                setTimeout(() => {
                    if(currentPage) currentPage.classList.remove('exiting');
                    document.querySelectorAll('.page-content').forEach(page => page.classList.remove('active'));
                    document.querySelectorAll('.sidebar-nav-item').forEach(nav => nav.classList.remove('active'));

                    const targetPage = document.getElementById(pageId);
                    let targetNavItemKey = pageId;
                    if (pageId === 'planejamento-divida-page') targetNavItemKey = 'liberdade-financeira-page';

                    const targetNavItem = document.querySelector(`.sidebar-nav-item[data-page="${targetNavItemKey}"]`);

                    if (targetPage) {
                        targetPage.classList.add('active');
                        window.scrollTo(0, 0);
                        renderPageContent(pageId, data);
                    }
                    if (targetNavItem) targetNavItem.classList.add('active');
                    
                    document.querySelectorAll('.form-container').forEach(form => {
                        if (form.id !== 'form-cadastro-produto-container' && form.id !== 'form-importar-planilha-container') {
                            if (pageId.includes('page') && !pageId.startsWith(form.id.split('-')[1])) {
                                // Lógica de esconder outros forms se necessário
                            }
                        }
                    });
                }, 200);
            }

            function renderPageContent(pageId, data) {
                switch(pageId) {
                    case 'dashboard-page': setupDashboardPage(); break;
                    case 'produtos-page': setupProductsPage(); break;
                    case 'vendas-page': setupVendasPage(data); break;
                    case 'clientes-page': setupClientesPage(); break;
                    case 'despesas-page': setupDespesasPage(); break;
                    case 'metas-page': setupMetasPage(); break;
                    case 'lucro-certo-page': setupLucroCertoPage(); break;
                    case 'liberdade-financeira-page': setupLiberdadeFinanceiraPage(); break;
                    case 'planejamento-divida-page': setupPlanejamentoDividaPage(data); break;
                }
            }
            
            function showToast(message, type = 'success') {
                let toast = document.querySelector('.toast-notification');
                if (!toast) {
                    toast = document.createElement('div');
                    toast.className = 'toast-notification';
                    document.body.appendChild(toast);
                }
                toast.textContent = message;
                toast.className = `toast-notification ${type}`; 
                setTimeout(() => { toast.classList.add('show'); }, 100);
                setTimeout(() => { toast.classList.remove('show'); }, 3000);
            }

            // =================================================================================
            // ============================== MÓDULO: DASHBOARD ================================
            // =================================================================================

            function setupDashboardPage() {
                updateDashboard();
            }

            function updateDashboard() {
                // Cálculos financeiros
                const receitaBruta = appState.sales.reduce((total, sale) => total + sale.total, 0);
                let custoProdutosVendidos = 0;
                appState.sales.forEach(sale => sale.items.forEach(item => {
                    const product = appState.products.find(p => p.id === item.productId);
                    if (product) custoProdutosVendidos += product.costPrice * item.quantity;
                }));
                const despesasFixas = appState.expenses.fixed.reduce((total, cost) => total + cost.value, 0);
                const lucroLiquido = receitaBruta - custoProdutosVendidos - despesasFixas;

                // Despesas a vencer
                const today = new Date(); today.setHours(0,0,0,0);
                const upcomingLimit = new Date(); upcomingLimit.setDate(today.getDate() + 7);
                const despesasVencimento = appState.expenses.fixed.filter(expense => {
                    if (!expense.dueDate) return false;
                    const dueDate = new Date(expense.dueDate + 'T03:00:00');
                    return dueDate >= today && dueDate <= upcomingLimit;
                });

                // Economia planejada
                const totalSavings = appState.debtPlans.reduce((sum, plan) => sum + plan.monthlyAmount, 0);

                // Atualizar Cards principais
                document.getElementById('dashboard-receita-bruta').textContent = `R$ ${receitaBruta.toFixed(2)}`;
                document.getElementById('dashboard-lucro-liquido').textContent = `R$ ${lucroLiquido.toFixed(2)}`;
                document.getElementById('dashboard-lucro-liquido').style.color = lucroLiquido < 0 ? '#ef4444' : '#1f2937';
                document.getElementById('dashboard-despesas-vencimento').textContent = despesasVencimento.length;
                document.getElementById('dashboard-economia-planejada').textContent = `R$ ${totalSavings.toFixed(2)}`;

                // Atualizar listas
                updateDashboardFinancialSummary(lucroLiquido, custoProdutosVendidos, despesasFixas);
                updateDashboardTopProducts();
                updateDashboardLowStock();
                updateDashboardGoals();
            }

            function updateDashboardFinancialSummary(lucro, custos, despesas) {
                 const financialList = document.getElementById('financial-summary-list');
                financialList.innerHTML = `
                    <li><span>Lucro Líquido</span> <strong>R$ ${lucro.toFixed(2)}</strong></li>
                    <li><span>Custo de Produtos</span> <strong>R$ ${custos.toFixed(2)}</strong></li>
                    <li><span>Despesas Fixas</span> <strong>R$ ${despesas.toFixed(2)}</strong></li>`;
            }

            function updateDashboardTopProducts() {
                const salesByProduct = {};
                appState.sales.forEach(sale => {
                    sale.items.forEach(item => {
                        const productInfo = appState.products.find(p => p.id === item.productId);
                        if(salesByProduct[item.productId]) {
                            salesByProduct[item.productId].quantity += item.quantity;
                        } else {
                            salesByProduct[item.productId] = { name: productInfo ? productInfo.name : 'Desconhecido', quantity: item.quantity };
                        }
                    });
                });
                const topProductsList = document.getElementById('top-products-list');
                topProductsList.innerHTML = '';
                const sortedBestSellers = Object.values(salesByProduct).sort((a, b) => b.quantity - a.quantity).slice(0, 5);
                if (sortedBestSellers.length > 0) {
                    sortedBestSellers.forEach(p => {
                        topProductsList.innerHTML += `<li><span>${p.name}</span> <strong>${p.quantity} un.</strong></li>`;
                    });
                } else {
                    topProductsList.innerHTML = '<li class="placeholder">Nenhuma venda registrada.</li>';
                }
            }

            function updateDashboardLowStock() {
                 const listaEstoqueBaixoEl = document.getElementById('dashboard-lista-estoque-baixo');
                const produtosEstoqueBaixo = appState.products.filter(p => p.stock <= appState.settings.lowStockThreshold);
                listaEstoqueBaixoEl.innerHTML = '';
                if (produtosEstoqueBaixo.length > 0) {
                     produtosEstoqueBaixo.forEach(p => {
                        listaEstoqueBaixoEl.innerHTML += `<li><span>${p.name}</span> <strong>${p.stock} unidades</strong></li>`;
                     });
                } else {
                    listaEstoqueBaixoEl.innerHTML = '<li class="placeholder">Nenhum produto com estoque baixo.</li>';
                }
            }

            function updateDashboardGoals() {
                const list = document.getElementById('dashboard-goals-list');
                list.innerHTML = ''; 

                ['daily', 'weekly', 'monthly'].forEach(period => {
                    const goal = appState.goals[period] || 0;
                    let currentTotal = 0;
                    const today = new Date('2025-06-07T17:30:00-03:00');
                    const todayStr = today.toISOString().split('T')[0];

                    if (period === 'daily') {
                        currentTotal = appState.sales.filter(s => s.date === todayStr).reduce((sum, s) => sum + s.total, 0);
                    } else if (period === 'weekly') {
                        const startOfWeek = new Date(today);
                        startOfWeek.setDate(startOfWeek.getDate() - today.getDay());
                        const startOfWeekStr = startOfWeek.toISOString().split('T')[0];
                        currentTotal = appState.sales.filter(s => s.date >= startOfWeekStr).reduce((sum, s) => sum + s.total, 0);
                    } else if (period === 'monthly') {
                        const startOfMonthStr = today.toISOString().slice(0, 8) + '01';
                        currentTotal = appState.sales.filter(s => s.date >= startOfMonthStr).reduce((sum, s) => sum + s.total, 0);
                    }
                    
                    const percentage = goal > 0 ? (currentTotal / goal) * 100 : 0;
                    const periodName = { daily: 'Diária', weekly: 'Semanal', monthly: 'Mensal' }[period];

                    const li = document.createElement('li');
                    li.innerHTML = `
                        <div class="goal-info">
                            <span>Meta ${periodName}</span>
                            <span class="goal-percentage">${Math.round(percentage)}%</span>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar-fill" style="width: ${Math.min(percentage, 100)}%;"></div>
                        </div>
                    `;
                    list.appendChild(li);
                });
            }
            
            // =================================================================================
            // ============================== MÓDULO: PRODUTOS ==================================
            // =================================================================================
            function setupProductsPage() {
                renderProductCards();
                setupProductFormListeners();
                
                document.getElementById('form-cadastro-produto-container').style.display = 'none';
                document.getElementById('form-importar-planilha-container').style.display = 'none';
            }

            function getUnitExpenses() {
                const totalUnitarioVariavel = appState.expenses.variable.reduce((sum, cost) => sum + cost.unitValue, 0);
                const totalUnitarioFrete = appState.expenses.freight.reduce((sum, cost) => sum + cost.unitValue, 0);
                return totalUnitarioVariavel + totalUnitarioFrete;
            }

            function updatePricingCalculation() {
                const costPrice = parseFloat(document.getElementById('produto-valor-custo').value) || 0;
                const unitExpenses = getUnitExpenses();
                const marginPercent = parseFloat(document.getElementById('produto-margem-lucro-slider').value);

                document.getElementById('produto-margem-lucro-label').textContent = marginPercent;

                const totalCost = costPrice + unitExpenses;
                let salePrice = 0;
                let profit = 0;

                if (totalCost > 0) {
                    salePrice = totalCost / (1 - (marginPercent / 100));
                    profit = salePrice - totalCost;
                }

                document.getElementById('produto-preco-sugerido').textContent = `R$ ${salePrice.toFixed(2)}`;
                document.getElementById('produto-lucro-estimado').textContent = `R$ ${profit.toFixed(2)}`;
            }

            function setupProductFormListeners() {
                const costInput = document.getElementById('produto-valor-custo');
                const marginSlider = document.getElementById('produto-margem-lucro-slider');

                costInput.addEventListener('input', updatePricingCalculation);
                marginSlider.addEventListener('input', updatePricingCalculation);
            }

            function renderProductCards() {
                const container = document.getElementById('product-cards-list');
                const noProductsMessage = document.getElementById('no-products-message');
                container.innerHTML = '';
                
                if (!appState.products || appState.products.length === 0) {
                    noProductsMessage.style.display = 'block';
                    return;
                }
                noProductsMessage.style.display = 'none';

                appState.products.forEach(produto => {
                    const cardDiv = document.createElement('div');
                    cardDiv.classList.add('product-card');
                    cardDiv.innerHTML = `
                        <img src="${produto.image || 'https://placehold.co/400x400/f8b81f/db1472?text=C4'}" alt="${produto.name}" class="product-card-image">
                        <h4>${produto.name}</h4>
                        <p><strong>Custo:</strong> R$ ${parseFloat(produto.costPrice || 0).toFixed(2)}</p>
                        <p><strong>Estoque:</strong> ${produto.stock || 0}</p>
                        <p><strong>Venda:</strong> ${produto.salePrice > 0 ? `R$ ${produto.salePrice.toFixed(2)}` : '<a href="#" class="link-definir-preco" data-product-id="'+produto.id+'">Definir</a>'}</p>
                        <div class="actions-cell">
                            <button class="btn btn-sm btn-secondary btn-edit-product" title="Editar" data-product-id="${produto.id}">Editar</button>
                        </div>
                    `;
                    container.appendChild(cardDiv);
                });
            }

            function handleProductFormSubmit(event) {
                event.preventDefault();
                const produtoId = document.getElementById('produto-id-edit').value;
                const salePrice = parseFloat(document.getElementById('produto-preco-sugerido').textContent.replace('R$ ', '')) || 0;

                if (salePrice <= 0) {
                    showToast("Defina um preço de venda válido movendo a régua de margem.", "error");
                    return;
                }

                const produtoData = {
                    id: produtoId || `prod_${Date.now()}`,
                    name: document.getElementById('produto-nome').value,
                    category: document.getElementById('produto-categoria').value,
                    costPrice: parseFloat(document.getElementById('produto-valor-custo').value) || 0,
                    stock: parseInt(document.getElementById('produto-estoque').value) || 0,
                    image: document.getElementById('produto-imagem-preview').src.startsWith('data:') ? document.getElementById('produto-imagem-preview').src : '',
                    salePrice: salePrice,
                    dateAdded: new Date().toISOString() // Adicionado para cálculo de tempo em estoque
                };

                if (produtoId) {
                    const index = appState.products.findIndex(p => p.id === produtoId);
                    if (index > -1) {
                         produtoData.dateAdded = appState.products[index].dateAdded; // Preserva a data original
                        appState.products[index] = { ...appState.products[index], ...produtoData };
                    }
                } else {
                    appState.products.push(produtoData);
                }

                saveState();
                renderProductCards();
                updateAllProductSelects();
                
                document.getElementById('form-cadastro-produto').reset();
                document.getElementById('form-cadastro-produto-container').style.display = 'none';
                showToast('Produto salvo com sucesso!', 'success');
            }

            function openProductFormForEdit(productId) {
                const product = appState.products.find(p => p.id === productId);
                if (!product) return;

                const formContainer = document.getElementById('form-cadastro-produto-container');
                const importContainer = document.getElementById('form-importar-planilha-container');
                importContainer.style.display = 'none';
                formContainer.style.display = 'block';

                document.getElementById('produto-id-edit').value = product.id;
                document.getElementById('produto-nome').value = product.name;
                document.getElementById('produto-categoria').value = product.category;
                const costInput = document.getElementById('produto-valor-custo');
                costInput.value = product.costPrice;
                document.getElementById('produto-estoque').value = product.stock;
                
                const preview = document.getElementById('produto-imagem-preview');
                preview.src = product.image || '#';
                preview.style.display = product.image ? 'block' : 'none';

                const unitExpenses = getUnitExpenses();
                document.getElementById('produto-custo-unitario-despesas').textContent = `R$ ${unitExpenses.toFixed(2)}`;
                const totalCost = product.costPrice + unitExpenses;
                let margin = 100;
                if (product.salePrice > totalCost) {
                    margin = (1 - (totalCost / product.salePrice)) * 100;
                }
                const marginSlider = document.getElementById('produto-margem-lucro-slider');
                marginSlider.value = Math.round(margin);
                
                updatePricingCalculation();
            }

            function handleCSVFileSelect(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    const text = e.target.result;
                    parseAndPreviewCSV(text);
                };
                reader.readAsText(file);
            }

            function parseAndPreviewCSV(csvText) {
                const lines = csvText.split('\n').filter(line => line.trim() !== '');
                const headers = lines.shift().trim().split(',').map(h => h.toLowerCase());
                
                const expectedHeaders = ['nome', 'categoria', 'precocusto', 'estoque'];
                if (headers.length !== expectedHeaders.length || !expectedHeaders.every((h, i) => headers[i].trim() === h)) {
                    showToast('O cabeçalho do arquivo CSV está incorreto. Use o modelo.', 'error');
                    return;
                }

                produtosImportadosParaConfirmacao = [];
                const previewContainer = document.getElementById('import-preview-container');
                
                const products = lines.map(line => {
                    const values = line.trim().split(',');
                    const product = {
                        name: values[0] || '',
                        category: values[1] || '',
                        costPrice: parseFloat(values[2]) || 0,
                        stock: parseInt(values[3]) || 0,
                        isValid: false
                    };
                    if (product.name && !isNaN(product.costPrice) && !isNaN(product.stock)) {
                        product.isValid = true;
                    }
                    return product;
                });

                if (products.length === 0) {
                    previewContainer.innerHTML = '<p>Nenhum produto encontrado no arquivo.</p>';
                    return;
                }

                let tableHTML = `<div id="import-preview-table-container">
                                    <table id="import-preview-table">
                                        <thead><tr><th>Nome</th><th>Categoria</th><th>Custo</th><th>Estoque</th></tr></thead>
                                        <tbody>`;
                products.forEach(p => {
                    tableHTML += `<tr class="${p.isValid ? '' : 'invalid-row'}">
                                    <td>${p.name}</td>
                                    <td>${p.category}</td>
                                    <td>R$ ${p.costPrice.toFixed(2)}</td>
                                    <td>${p.stock}</td>
                                  </tr>`;
                    if (p.isValid) {
                        produtosImportadosParaConfirmacao.push(p);
                    }
                });
                tableHTML += `</tbody></table></div>`;
                previewContainer.innerHTML = tableHTML;

                document.getElementById('import-actions').style.display = 'flex';
            }

            function handleConfirmImport() {
                if(produtosImportadosParaConfirmacao.length === 0) {
                    showToast('Nenhum produto válido para importar.', 'error');
                    return;
                }

                const newProducts = produtosImportadosParaConfirmacao.map(p => ({
                    id: `prod_${Date.now()}_${Math.random()}`,
                    name: p.name,
                    category: p.category,
                    costPrice: p.costPrice,
                    stock: p.stock,
                    salePrice: 0, 
                    image: '',
                    dateAdded: new Date().toISOString()
                }));

                appState.products.push(...newProducts);
                saveState();
                
                showToast(`${newProducts.length} produtos importados com sucesso!`, 'success');
                renderProductCards();
                
                document.getElementById('form-importar-planilha-container').style.display = 'none';
                document.getElementById('import-csv-file').value = '';
                document.getElementById('import-preview-container').innerHTML = '';
                document.getElementById('import-actions').style.display = 'none';
            }


            // =================================================================================
            // =============================== MÓDULO: VENDAS (ATUALIZADO) =====================
            // =================================================================================
            function setupVendasPage(data = null) {
                renderSalesHistory();
                populateSalesProductSelect();
                updateCurrentSaleUI();

                if (data && data.clientName) {
                    document.getElementById('btn-show-nova-venda-form').click();
                    document.getElementById('venda-cliente').value = data.clientName;
                    document.getElementById('venda-cliente-telefone').value = data.clientPhone || '';
                }
            }

            function populateSalesProductSelect() {
                const select = document.getElementById('venda-produto-select');
                if (!select) return;
                select.innerHTML = '<option value="">Selecione um produto</option>'; 
                appState.products.forEach(produto => {
                    const option = document.createElement('option');
                    option.value = produto.id;
                    const precoDefinido = produto.salePrice && produto.salePrice > 0;
                    option.textContent = `${produto.name} (Est: ${produto.stock}) - ${precoDefinido ? `R$ ${produto.salePrice.toFixed(2)}` : 'Preço não definido'}`;
                    option.dataset.price = produto.salePrice;
                    option.dataset.stock = produto.stock;
                    option.dataset.name = produto.name;
                    option.disabled = produto.stock <= 0 || !precoDefinido;
                    select.appendChild(option);
                });
            }

            function renderSalesHistory() {
                const container = document.getElementById('sales-history-cards-list');
                const noSalesMessage = document.getElementById('no-vendas-message');
                container.innerHTML = '';
                if (!appState.sales || appState.sales.length === 0) {
                    noSalesMessage.style.display = 'block';
                    container.style.display = 'none';
                    return;
                }
                noSalesMessage.style.display = 'none';
                container.style.display = 'grid';

                const sortedSales = [...appState.sales].sort((a, b) => new Date(b.date) - new Date(a.date));

                sortedSales.forEach(venda => {
                    const cardDiv = document.createElement('div');
                    cardDiv.classList.add('sale-card');
                    cardDiv.innerHTML = `
                        <h4>Venda #${venda.id.substring(4,10)}</h4>
                        <p><strong>Cliente:</strong> ${venda.client || 'Não informado'}</p>
                        <p><strong>Data:</strong> ${new Date(venda.date + 'T03:00:00').toLocaleDateString('pt-BR')}</p>
                        <p><strong>Total:</strong> R$ ${venda.total.toFixed(2)}</p>
                        <p><strong>Itens:</strong> ${venda.items.reduce((sum, item) => sum + item.quantity, 0)}</p>
                    `;
                    container.appendChild(cardDiv);
                });
            }

            function updateCurrentSaleUI() {
                const listEl = document.getElementById('venda-itens-lista');
                listEl.innerHTML = ''; 
                if (itensVendaTemporarios.length === 0) {
                    listEl.innerHTML = '<p id="venda-sem-itens" style="text-align: center; color: #6b7280; padding: 1rem 0;">Nenhum item adicionado.</p>';
                } else {
                    itensVendaTemporarios.forEach((item, index) => {
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <div class="sale-item-details"><strong>${item.name}</strong> (${item.quantity} x R$ ${item.unitPrice.toFixed(2)})</div>
                            <span>R$ ${item.subtotal.toFixed(2)}</span>
                            <button type="button" class="remove-item-btn" data-index="${index}" title="Remover">&times;</button>
                        `;
                        listEl.appendChild(li);
                    });
                }
                
                const subtotal = itensVendaTemporarios.reduce((sum, item) => sum + item.subtotal, 0);
                const descontoPerc = parseFloat(document.getElementById('venda-desconto').value) || 0;
                const valorDesconto = (subtotal * descontoPerc) / 100;
                document.getElementById('venda-subtotal').textContent = `R$ ${subtotal.toFixed(2)}`;
                document.getElementById('venda-desconto-perc').textContent = descontoPerc;
                document.getElementById('venda-valor-desconto').textContent = `- R$ ${valorDesconto.toFixed(2)}`;
                document.getElementById('venda-total-pagar').textContent = `R$ ${(subtotal - valorDesconto).toFixed(2)}`;
            }

            function handleNewSaleSubmit(event) {
                event.preventDefault();
                const clientName = document.getElementById('venda-cliente').value;
                if (!clientName) {
                    showToast('O nome do cliente é obrigatório.', 'error');
                    return;
                }
                if (itensVendaTemporarios.length === 0) {
                    showToast('Adicione produtos à venda.', 'error'); return;
                }

                itensVendaTemporarios.forEach(itemVendido => {
                    const produtoNoEstoque = appState.products.find(p => p.id === itemVendido.productId);
                    if (produtoNoEstoque) produtoNoEstoque.stock -= itemVendido.quantity;
                });

                const totalVenda = parseFloat(document.getElementById('venda-total-pagar').textContent.replace('R$ ', '').replace(',', '.'));
                const novaVenda = {
                    id: `VEN_${Date.now()}`,
                    date: new Date().toISOString().split('T')[0],
                    client: clientName,
                    phone: document.getElementById('venda-cliente-telefone').value, // NOVO
                    items: [...itensVendaTemporarios],
                    total: totalVenda,
                    status: 'pago'
                };
                appState.sales.push(novaVenda);

                saveState();
                showToast(`Venda para ${clientName} registrada com sucesso!`);
                
                itensVendaTemporarios = [];
                document.getElementById('form-nova-venda').reset();
                document.getElementById('form-nova-venda-container').style.display = 'none';
                document.getElementById('btn-show-nova-venda-form').style.display = 'inline-flex';
                
                renderSalesHistory();
                updateDashboard();
                if (document.getElementById('metas-page').classList.contains('active')) {
                    setupMetasPage();
                }
            }

            // =================================================================================
            // ========================= MÓDULO: CLIENTES (NOVO) ===============================
            // =================================================================================
            function setupClientesPage() {
                const customers = {};
                appState.sales.forEach(sale => {
                    const key = sale.client.trim().toLowerCase();
                    if (!key) return;

                    if (!customers[key] || new Date(sale.date) > new Date(customers[key].lastSale.date)) {
                        customers[key] = {
                            name: sale.client,
                            phone: sale.phone,
                            lastSale: sale,
                        };
                    }
                });
                
                const customerList = Object.values(customers).sort((a,b) => new Date(b.lastSale.date) - new Date(a.lastSale.date));
                renderCustomerCards(customerList);
            }

            function calculateTimeSince(dateString) {
                const saleDate = new Date(dateString + 'T03:00:00');
                const today = new Date('2025-06-07T17:30:00-03:00');
                const diffTime = Math.abs(today - saleDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                if (diffDays === 0) return 'hoje';
                if (diffDays === 1) return 'há 1 dia';
                if (diffDays <= 30) return `há ${diffDays} dias`;
                const diffMonths = Math.floor(diffDays / 30);
                if (diffMonths === 1) return 'há 1 mês';
                return `há ${diffMonths} meses`;
            }

            function renderCustomerCards(customerList) {
                const container = document.getElementById('customer-cards-container');
                const noCustomersMsg = document.getElementById('no-customers-message');
                container.innerHTML = '';

                if (customerList.length === 0) {
                    noCustomersMsg.style.display = 'block';
                    return;
                }
                noCustomersMsg.style.display = 'none';

                customerList.forEach(customer => {
                    const timeSince = calculateTimeSince(customer.lastSale.date);
                    const daysSince = (new Date('2025-06-07T17:30:00-03:00') - new Date(customer.lastSale.date + 'T03:00:00')) / (1000 * 60 * 60 * 24);
                    const isDormant = daysSince > 30;

                    const card = document.createElement('div');
                    card.className = `customer-card ${isDormant ? 'dormant' : ''}`;
                    
                    let itemsHtml = '<ul class="last-purchase-list">';
                    customer.lastSale.items.forEach(item => {
                        itemsHtml += `<li>- ${item.quantity}x ${item.name}</li>`;
                    });
                    itemsHtml += '</ul>';

                    card.innerHTML = `
                        <div class="customer-card-header">
                            <div>
                                <h4>${customer.name}</h4>
                                <p>${customer.phone || 'Telefone não cadastrado'}</p>
                            </div>
                            <span class="status-badge status-pago" style="flex-shrink: 0;">${timeSince}</span>
                        </div>
                        <div class="customer-card-info">
                             <p class="last-purchase-title">Última Compra:</p>
                             ${itemsHtml}
                        </div>
                        <div class="form-actions" style="justify-content: flex-end;">
                            <button class="btn btn-primary btn-sm btn-sell-again" data-name="${customer.name}" data-phone="${customer.phone || ''}">Vender Novamente</button>
                        </div>
                    `;
                    container.appendChild(card);
                });
            }


            // =================================================================================
            // ========================= MÓDULO: DESPESAS =========================
            // =================================================================================
            function setupDespesasPage() {
                renderFixedCosts();
                renderVariableCosts();
                renderFreightCosts();
                renderTaxCosts();
                updateDespesasSummary();
            }

            function renderFixedCosts() {
                const list = document.getElementById('lista-custos-fixos');
                list.innerHTML = '';
                if(!appState.expenses.fixed || appState.expenses.fixed.length === 0) {
                    list.innerHTML = '<li class="placeholder">Nenhum custo fixo.</li>';
                    return;
                } 
                appState.expenses.fixed.forEach(cost => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <div class="cost-details"><span class="cost-name">${cost.name}</span></div>
                        <span class="cost-value">R$ ${cost.value.toFixed(2)}</span>
                        <button type="button" class="remove-cost-btn" data-id="${cost.id}" data-type="fixed" title="Remover">&times;</button>
                    `;
                    list.appendChild(li);
                });
            }
            
            function renderVariableCosts() {
                const list = document.getElementById('lista-custos-variaveis');
                list.innerHTML = '';
                if(!appState.expenses.variable || appState.expenses.variable.length === 0) {
                    list.innerHTML = '<li class="placeholder">Nenhum custo variável.</li>';
                    return;
                } 
                appState.expenses.variable.forEach(cost => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <div class="cost-details"><span class="cost-name">${cost.name}</span></div>
                        <span class="cost-value">R$ ${cost.unitValue.toFixed(2)}</span>
                        <button type="button" class="remove-cost-btn" data-id="${cost.id}" data-type="variable" title="Remover">&times;</button>
                    `;
                    list.appendChild(li);
                });
            }

            function renderFreightCosts() {
                const list = document.getElementById('lista-custos-frete');
                list.innerHTML = '';
                if(!appState.expenses.freight || appState.expenses.freight.length === 0) {
                    list.innerHTML = '<li class="placeholder">Nenhum frete adicionado.</li>';
                    return;
                } 
                appState.expenses.freight.forEach(cost => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <div class="cost-details">
                            <span class="cost-name">Frete (R$ ${cost.totalValue.toFixed(2)} / ${cost.quantity} pçs)</span>
                            <span class="cost-unit">Custo por unidade: R$ ${cost.unitValue.toFixed(2)}</span>
                        </div>
                        <button type="button" class="remove-cost-btn" data-id="${cost.id}" data-type="freight" title="Remover">&times;</button>
                    `;
                    list.appendChild(li);
                });
            }

            function renderTaxCosts() {
                const list = document.getElementById('lista-custos-impostos');
                list.innerHTML = '';
                 if(!appState.expenses.taxes || appState.expenses.taxes.length === 0) {
                    list.innerHTML = '<li class="placeholder">Nenhum imposto.</li>';
                    return;
                }
                appState.expenses.taxes.forEach(cost => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <div class="cost-details"><span class="cost-name">${cost.name}</span></div>
                        <span class="cost-value">${cost.percentageValue}%</span>
                        <button type="button" class="remove-cost-btn" data-id="${cost.id}" data-type="tax" title="Remover">&times;</button>
                    `;
                    list.appendChild(li);
                });
            }

            function handleAddFixedCost(event) {
                event.preventDefault();
                const name = document.getElementById('custo-fixo-nome').value;
                const value = parseFloat(document.getElementById('custo-fixo-valor').value);
                const dueDate = document.getElementById('custo-fixo-vencimento').value;
                if (!name || isNaN(value) || value <= 0 || !dueDate) { alert("Preencha todos os campos."); return; }
                appState.expenses.fixed.push({ id: `fix_${Date.now()}`, name, value, dueDate });
                saveState();
                renderFixedCosts();
                updateDespesasSummary();
                event.target.reset();
            }
            
            function handleAddVariableCost(event) {
                event.preventDefault();
                const name = document.getElementById('custo-variavel-nome').value;
                const unitValue = parseFloat(document.getElementById('custo-variavel-valor-unitario').value);
                if (!name || isNaN(unitValue) || unitValue <= 0) { alert("Preencha todos os campos."); return; }
                appState.expenses.variable.push({ id: `var_${Date.now()}`, name, unitValue });
                saveState();
                renderVariableCosts();
                updateDespesasSummary();
                event.target.reset();
            }

            function handleAddFreightCost(event) {
                 event.preventDefault();
                const totalValue = parseFloat(document.getElementById('frete-valor-total').value);
                const quantity = parseInt(document.getElementById('frete-quantidade-pecas').value);
                if (isNaN(totalValue) || totalValue <= 0 || isNaN(quantity) || quantity <= 0) { alert("Preencha valores válidos para frete."); return; }
                
                const unitValue = totalValue / quantity;
                const name = `Frete Compra (${new Date().toLocaleDateString('pt-BR')})`;
                appState.expenses.freight.push({ id: `frt_${Date.now()}`, name, totalValue, quantity, unitValue });
                saveState();
                renderFreightCosts();
                updateDespesasSummary();
                showToast(`Custo unitário do frete: R$ ${unitValue.toFixed(2)}`, 'success');
                event.target.reset();
            }

             function handleAddTaxCost(event) {
                event.preventDefault();
                const name = document.getElementById('imposto-nome').value;
                const percentageValue = parseFloat(document.getElementById('imposto-valor-percentual').value);
                if (!name || isNaN(percentageValue) || percentageValue < 0) { alert("Preencha um nome e percentual válidos."); return; }
                appState.expenses.taxes.push({ id: `tax_${Date.now()}`, name, percentageValue });
                saveState();
                renderTaxCosts();
                updateDespesasSummary();
                event.target.reset();
            }

            function handleRemoveCost(type, id) {
                if(type === 'fixed') appState.expenses.fixed = appState.expenses.fixed.filter(c => c.id !== id);
                else if(type === 'variable') appState.expenses.variable = appState.expenses.variable.filter(c => c.id !== id);
                else if(type === 'freight') appState.expenses.freight = appState.expenses.freight.filter(c => c.id !== id);
                else if(type === 'tax') appState.expenses.taxes = appState.expenses.taxes.filter(c => c.id !== id);
                
                saveState();
                setupDespesasPage();
            }

            function updateDespesasSummary() {
                const totalFixo = appState.expenses.fixed.reduce((sum, cost) => sum + cost.value, 0);
                const custoTotalUnitario = getUnitExpenses();

                document.querySelector('#summary-total-fixo .value').textContent = `R$ ${totalFixo.toFixed(2)}`;
                document.querySelector('#summary-total-unitario .value').textContent = `R$ ${custoTotalUnitario.toFixed(2)}`;
                
                const totalUnitarioVariavel = appState.expenses.variable.reduce((sum, cost) => sum + cost.unitValue, 0);
                const totalUnitarioFrete = appState.expenses.freight.reduce((sum, cost) => sum + cost.unitValue, 0);
                const totalPercentualImposto = appState.expenses.taxes.reduce((sum, cost) => sum + cost.percentageValue, 0);

                updateDespesasChart({
                    variavel: totalUnitarioVariavel,
                    frete: totalUnitarioFrete,
                    imposto: totalPercentualImposto > 0 ? (custoTotalUnitario * totalPercentualImposto) / 100 : 0
                });
            }
            
            function updateDespesasChart(data) {
                const ctx = document.getElementById('despesas-pie-chart').getContext('2d');
                if (despesasChartInstance) {
                    despesasChartInstance.destroy();
                }

                const labels = [];
                const values = [];
                const colors = [];

                if(data.variavel > 0) { labels.push('Custos Variáveis'); values.push(data.variavel); colors.push('#f8b81f'); }
                if(data.frete > 0) { labels.push('Custo de Frete'); values.push(data.frete); colors.push('#ec4899'); }
                if(data.imposto > 0) { labels.push('Impostos (Estimado)'); values.push(data.imposto); colors.push('#ef4444'); }
                
                if(values.length === 0){
                     labels.push('Sem custos unitários');
                     values.push(1);
                     colors.push('#e2e8f0');
                }

                despesasChartInstance = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{ data: values, backgroundColor: colors, borderColor: '#fff', borderWidth: 2 }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' },
                            tooltip: { callbacks: { label: (context) => `R$ ${context.parsed.toFixed(2)}` } }
                        }
                    }
                });
            }


             // =================================================================================
            // ======================== MÓDULO: LIBERDADE FINANCEIRA (ATUALIZADO) ==================
            // =================================================================================
            function setupLiberdadeFinanceiraPage() {
                renderDebtCards();
                updateLFCards();
                document.getElementById('form-add-debt-container').style.display = 'none';
                document.getElementById('btn-show-add-debt-form').style.display = 'inline-flex';
            }

            function updateLFCards() {
                const totalDebts = appState.debts.reduce((sum, debt) => sum + debt.value, 0);
                document.getElementById('lf-total-dividas').textContent = `R$ ${totalDebts.toFixed(2)}`;

                const totalSavings = appState.debtPlans.reduce((sum, plan) => sum + plan.monthlyAmount, 0);
                document.getElementById('lf-total-economias').textContent = `R$ ${totalSavings.toFixed(2)}`;
            }
            
            function renderDebtCards() {
                const container = document.getElementById('debt-cards-container');
                const noDebtsMsg = document.getElementById('no-debts-message');
                container.innerHTML = '';
                
                if (!appState.debts || appState.debts.length === 0) {
                    noDebtsMsg.style.display = 'block';
                    container.style.display = 'none';
                    return;
                }
                noDebtsMsg.style.display = 'none';
                container.style.display = 'grid';

                appState.debts.forEach(debt => {
                    const card = document.createElement('div');
                    card.className = `debt-card prioridade-${debt.priority}`;
                    card.innerHTML = `
                        <h4>${debt.name}</h4>
                        <p><strong>Valor:</strong> R$ ${debt.value.toFixed(2)}</p>
                        <p><strong>Prioridade:</strong> <span style="text-transform: capitalize;">${debt.priority}</span></p>
                        <div class="debt-actions">
                            <button class="btn btn-sm btn-primary btn-plan-payment" data-debt-id="${debt.id}">Planejar Pagamento</button>
                        </div>
                    `;
                    container.appendChild(card);
                });
            }

            function handleAddDebt(event) {
                event.preventDefault();
                const name = document.getElementById('debt-name').value;
                const value = parseFloat(document.getElementById('debt-value').value);
                const priority = document.getElementById('debt-priority').value;

                if (!name || isNaN(value) || value <= 0) {
                    alert("Preencha nome e valor da dívida."); return;
                }
                appState.debts.push({ id: `debt_${Date.now()}`, name, value, priority, paid: 0 });
                saveState();
                renderDebtCards();
                updateLFCards();
                event.target.reset();
                document.getElementById('form-add-debt-container').style.display = 'none';
                document.getElementById('btn-show-add-debt-form').style.display = 'inline-flex';
            }

            function setupPlanejamentoDividaPage(debtId) {
                const debt = appState.debts.find(d => d.id === debtId);
                if (!debt) { setActivePage('liberdade-financeira-page'); return; }

                document.getElementById('planejamento-divida-titulo').textContent = `Planejar Quitação: ${debt.name}`;
                document.getElementById('plan-debt-id').value = debt.id;
                document.getElementById('plan-debt-name-display').value = `${debt.name} (R$ ${debt.value.toFixed(2)})`;
                
                const form = document.getElementById('form-planejar-divida');
                const valorInput = document.getElementById('planejar-divida-valor');
                const freqSelect = document.getElementById('planejar-divida-frequencia');
                
                // Resetar e recriar listeners para evitar duplicação
                const newForm = form.cloneNode(true);
                form.parentNode.replaceChild(newForm, form);
                
                newForm.addEventListener('input', () => updateDebtPlanSimulation(debt));
                newForm.addEventListener('submit', (e) => handleSaveDebtPlan(e, debt));

                updateDebtPlanSimulation(debt); // Executar uma vez para limpar os campos
            }

            function updateDebtPlanSimulation(debt) {
                const valor = parseFloat(document.getElementById('planejar-divida-valor').value) || 0;
                const freq = document.getElementById('planejar-divida-frequencia').value;
                const durationEl = document.getElementById('plan-duration-result');
                const salesEl = document.getElementById('plan-sales-needed-result');
                const motivationEl = document.getElementById('plan-motivation-message');

                if (valor <= 0) {
                    durationEl.textContent = '--';
                    salesEl.textContent = '--';
                    motivationEl.style.display = 'none';
                    return;
                }

                let monthlyAmount = valor;
                if (freq === 'dia') monthlyAmount = valor * 30;
                if (freq === 'quinzena') monthlyAmount = valor * 2;
                
                const monthsToPay = debt.value / monthlyAmount;
                const fullMonths = Math.floor(monthsToPay);
                const remainingDays = Math.ceil((monthsToPay - fullMonths) * 30);
                durationEl.textContent = `${fullMonths} ${fullMonths > 1 ? 'meses' : 'mês'} e ${remainingDays} dias`;

                let totalProfit = 0;
                let pricedProducts = 0;
                appState.products.forEach(p => {
                    if (p.salePrice > 0) {
                        totalProfit += (p.salePrice - p.costPrice);
                        pricedProducts++;
                    }
                });
                
                const avgProfit = pricedProducts > 0 ? totalProfit / pricedProducts : 0;

                if(avgProfit > 0) {
                    const salesNeeded = Math.ceil(monthlyAmount / avgProfit);
                    salesEl.textContent = `${salesNeeded} vendas/mês`;
                } else {
                    salesEl.textContent = 'Defina preços!';
                }

                motivationEl.textContent = motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)];
                motivationEl.style.display = 'block';
            }

            function handleSaveDebtPlan(event, debt) {
                event.preventDefault();
                const valor = parseFloat(document.getElementById('planejar-divida-valor').value) || 0;
                const frequencia = document.getElementById('planejar-divida-frequencia').value;
                
                if (valor <= 0) { showToast('Insira um valor de economia válido.', 'error'); return; }

                let monthlyAmount = valor;
                if (frequencia === 'dia') monthlyAmount = valor * 30;
                if (frequencia === 'quinzena') monthlyAmount = valor * 2;
                
                const newPlan = { planId: `plan_${debt.id}`, debtId: debt.id, amount: valor, frequency: frequencia, monthlyAmount: monthlyAmount };
                
                const existingPlanIndex = appState.debtPlans.findIndex(p => p.debtId === debt.id);
                if(existingPlanIndex > -1) {
                    appState.debtPlans[existingPlanIndex] = newPlan;
                } else {
                    appState.debtPlans.push(newPlan);
                }

                saveState();
                showToast("Planejamento salvo com sucesso!");
                setActivePage('liberdade-financeira-page');
            }


            // =================================================================================
            // ============================ MÓDULO: LUCRO CERTO (CALCULADORA) ====================
            // =================================================================================
            
            function setupLucroCertoPage() {
                const select = document.getElementById('lucro-produto-select');
                select.innerHTML = '<option value="">-- Escolha um Produto --</option>';
                appState.products.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = p.name;
                    select.appendChild(option);
                });
                
                document.getElementById('lucro-certo-content').style.display = 'none';
                document.getElementById('lucro-certo-selecione-produto-msg').style.display = 'block';
            }

            function handleLucroCertoProductSelect(event) {
                const productId = event.target.value;
                produtoSelecionadoLucroCerto = appState.products.find(p => p.id === productId) || null;

                const contentEl = document.getElementById('lucro-certo-content');
                const msgEl = document.getElementById('lucro-certo-selecione-produto-msg');

                if (produtoSelecionadoLucroCerto) {
                    contentEl.style.display = 'block';
                    msgEl.style.display = 'none';
                    document.getElementById('lucro-nome-produto-display').textContent = produtoSelecionadoLucroCerto.name;
                    calculateAndDisplayLucroCerto();
                } else {
                     contentEl.style.display = 'none';
                     msgEl.style.display = 'block';
                }
            }

            function calculateAndDisplayLucroCerto() {
                if (!produtoSelecionadoLucroCerto) return;

                const totalFixedCosts = appState.expenses.fixed.reduce((sum, cost) => sum + cost.value, 0);
                const fixedCostPerUnit = totalFixedCosts / (appState.settings.estimatedMonthlySales || 1);
                const totalVariableCost = appState.expenses.variable.reduce((sum, cost) => sum + cost.unitValue, 0);
                const freightCost = getUnitExpenses();
                const purchaseCost = produtoSelecionadoLucroCerto.costPrice;

                const totalUnitCost = purchaseCost + totalVariableCost + fixedCostPerUnit + freightCost;

                document.getElementById('lucro-display-custo-fixo').textContent = `R$ ${fixedCostPerUnit.toFixed(2)}`;
                document.getElementById('lucro-display-custo-variavel').textContent = `R$ ${totalVariableCost.toFixed(2)}`;
                document.getElementById('lucro-display-custo-frete').textContent = `R$ ${freightCost.toFixed(2)}`;
                document.getElementById('lucro-display-custo-compra').textContent = `R$ ${purchaseCost.toFixed(2)}`;
                document.getElementById('lucro-custo-total-display').textContent = `R$ ${totalUnitCost.toFixed(2)}`;

                const marginInput = document.getElementById('lucro-margem-input');
                const margin = parseFloat(marginInput.value) || 100;

                const salePrice = totalUnitCost / (1 - (margin / 100));
                const netProfit = salePrice - totalUnitCost;

                document.getElementById('lucro-preco-venda-sugerido').textContent = `R$ ${salePrice.toFixed(2)}`;
                document.getElementById('lucro-liquido-unidade').textContent = `Lucro de R$ ${netProfit.toFixed(2)} por unidade`;

                document.getElementById('lucro-alerta-margem').style.display = margin < 20 ? 'block' : 'none';

                updateLucroChart({ purchaseCost, totalVariableCost, fixedCostPerUnit, freightCost, netProfit });
            }
            
            function updateLucroChart(data) {
                const ctx = document.getElementById('lucro-produto-chart').getContext('2d');
                if (lucroProdutoChartInstance) lucroProdutoChartInstance.destroy();
                if (data.netProfit < 0) data.netProfit = 0;

                lucroProdutoChartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Custo de Compra', 'Custo Variável', 'Custo Fixo', 'Frete', 'Lucro Líquido'],
                        datasets: [{
                            data: [ data.purchaseCost, data.totalVariableCost, data.fixedCostPerUnit, data.freightCost, data.netProfit ],
                            backgroundColor: [ '#db1472', '#f8b81f', '#fbcfe8', '#fee2e2', '#10b981' ],
                            borderColor: '#fff', borderWidth: 2,
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false, cutout: '60%',
                        plugins: {
                            legend: { position: 'bottom' },
                            tooltip: { callbacks: { label: (c) => `${c.label}: R$ ${c.parsed.toFixed(2)}` } }
                        }
                    }
                });
            }

            function handleSalvarPrecoLucroCerto() {
                if(!produtoSelecionadoLucroCerto) { showToast('Nenhum produto selecionado.', 'error'); return; }
                const newPriceText = document.getElementById('lucro-preco-venda-sugerido').textContent;
                const newPrice = parseFloat(newPriceText.replace('R$ ', '').replace(',', '.'));
                
                if(isNaN(newPrice) || newPrice <= 0) { showToast('Preço inválido.', 'error'); return; }
                
                const productIndex = appState.products.findIndex(p => p.id === produtoSelecionadoLucroCerto.id);
                if(productIndex > -1) {
                    appState.products[productIndex].salePrice = newPrice;
                    saveState();
                    showToast(`Preço de "${appState.products[productIndex].name}" atualizado!`);
                    updateAllProductSelects();
                    if(document.getElementById('produtos-page').classList.contains('active')) renderProductCards();
                }
            }

            // =================================================================================
            // ============================= MÓDULO: METAS (NOVO) ==============================
            // =================================================================================
            function setupMetasPage() {
                ['daily', 'weekly', 'monthly'].forEach(period => {
                    const goal = appState.goals[period] || 0;
                    document.getElementById(`${period}-goal-input`).value = goal > 0 ? goal : '';
                    updateGoalChart(period);
                });
            }

            function handleSaveGoal(period) {
                const input = document.getElementById(`${period}-goal-input`);
                const value = parseFloat(input.value) || 0;
                appState.goals[period] = value;
                saveState();
                showToast(`Meta ${period.charAt(0).toUpperCase() + period.slice(1)} salva!`);
                updateGoalChart(period);
            }

            function updateGoalChart(period) {
                const goal = appState.goals[period] || 0;
                let currentTotal = 0;
                const today = new Date('2025-06-07T17:30:00-03:00');
                const todayStr = today.toISOString().split('T')[0];
                
                if (period === 'daily') {
                    currentTotal = appState.sales.filter(s => s.date === todayStr).reduce((sum, s) => sum + s.total, 0);
                } else if (period === 'weekly') {
                    const startOfWeek = new Date(today);
                    startOfWeek.setDate(startOfWeek.getDate() - today.getDay());
                    const startOfWeekStr = startOfWeek.toISOString().split('T')[0];
                    currentTotal = appState.sales.filter(s => s.date >= startOfWeekStr).reduce((sum, s) => sum + s.total, 0);
                } else if (period === 'monthly') {
                    const startOfMonthStr = today.toISOString().slice(0, 8) + '01';
                     currentTotal = appState.sales.filter(s => s.date >= startOfMonthStr).reduce((sum, s) => sum + s.total, 0);
                }
                
                const percentage = goal > 0 ? (currentTotal / goal) * 100 : 0;
                renderGoalChart(period, percentage, currentTotal, goal);
            }
            
            function renderGoalChart(period, percentage, current, goal) {
                const canvas = document.getElementById(`${period}-goal-chart`);
                const ctx = canvas.getContext('2d');
                if (goalCharts[period]) {
                    goalCharts[period].destroy();
                }

                const progress = Math.min(percentage / 100, 1);

                // Criar o gradiente para a barra de progresso
                const gradient = ctx.createLinearGradient(0, 0, 0, 150);
                gradient.addColorStop(0, '#DB1472'); // Cor primária (rosa)
                gradient.addColorStop(1, '#F8B81F'); // Cor secundária (amarelo)


                goalCharts[period] = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        datasets: [{
                            data: [progress, 1 - progress > 0.001 ? 1 - progress : 0],
                            backgroundColor: [gradient, '#e2e8f0'],
                            borderWidth: 0,
                            circumference: 180,
                            rotation: -90,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        plugins: {
                            tooltip: { enabled: false },
                            datalabels: {
                                color: '#500724',
                                formatter: () => {
                                    return `${Math.round(percentage)}%\n(R$ ${current.toFixed(2)})`;
                                },
                                font: { 
                                    size: 14, 
                                    weight: 'bold' 
                                },
                                textAlign: 'center',
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            }


            // =================================================================================
            // ============================= FUNÇÕES GLOBAIS DE APOIO ==========================
            // =================================================================================
            function updateAllProductSelects() {
                if (document.getElementById('vendas-page').classList.contains('active')) populateSalesProductSelect();
                if (document.getElementById('lucro-certo-page').classList.contains('active')) setupLucroCertoPage();
            }

            // =================================================================================
            // ========================== INICIALIZAÇÃO E EVENT LISTENERS ========================
            // =================================================================================
            
            function initializeApp() {
                loadState();

                // --- Navegação Principal ---
                document.getElementById('menu-toggle-btn').addEventListener('click', openSidebar);
                document.getElementById('close-sidebar-btn').addEventListener('click', closeSidebar);
                appOverlay.addEventListener('click', closeSidebar); 
                document.querySelectorAll('.sidebar-nav-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        setActivePage(item.dataset.page);
                        closeSidebar(); 
                    });
                });
                document.querySelectorAll('.btn-action[data-target-page], #plan-ai-assistant button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.preventDefault();
                        const targetPage = button.dataset.targetPage;
                        if(targetPage) setActivePage(targetPage);
                    });
                });
                
                // --- Listeners Página de Produtos ---
                document.getElementById('btn-show-add-product-form').addEventListener('click', () => {
                    document.getElementById('form-importar-planilha-container').style.display = 'none';
                    const formContainer = document.getElementById('form-cadastro-produto-container');
                    formContainer.style.display = 'block';
                    const form = formContainer.querySelector('form');
                    form.reset();
                    document.getElementById('produto-id-edit').value = '';
                    document.getElementById('produto-imagem-preview').style.display = 'none';
                    const unitExpenses = getUnitExpenses();
                    document.getElementById('produto-custo-unitario-despesas').textContent = `R$ ${unitExpenses.toFixed(2)}`;
                    updatePricingCalculation();
                });
                document.getElementById('btn-show-import-product-form').addEventListener('click', () => {
                    document.getElementById('form-cadastro-produto-container').style.display = 'none';
                    document.getElementById('form-importar-planilha-container').style.display = 'block';
                });
                document.getElementById('btn-cancel-add-product').addEventListener('click', () => {
                     document.getElementById('form-cadastro-produto-container').style.display = 'none';
                });
                document.getElementById('form-cadastro-produto').addEventListener('submit', handleProductFormSubmit);
                document.getElementById('product-cards-list').addEventListener('click', event => {
                    const editButton = event.target.closest('.btn-edit-product');
                    if (editButton) openProductFormForEdit(editButton.dataset.productId);
                    const priceLink = event.target.closest('.link-definir-preco');
                     if (priceLink) {
                        event.preventDefault();
                        openProductFormForEdit(priceLink.dataset.productId);
                    }
                });
                document.getElementById('produto-imagem').addEventListener('change', function() {
                    if (this.files && this.files[0]) {
                        const reader = new FileReader();
                        reader.onload = e => {
                           const preview = document.getElementById('produto-imagem-preview');
                           preview.src = e.target.result;
                           preview.style.display = 'block';
                        }
                        reader.readAsDataURL(this.files[0]);
                    }
                });
                document.getElementById('download-csv-template').addEventListener('click', (e) => {
                    e.preventDefault();
                    const csvContent = "data:text/csv;charset=utf-8,Nome,Categoria,PrecoCusto,Estoque\nBolsa Exemplo,bolsas,75.50,10\nSapato Teste,calcados,99.90,25";
                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", "modelo_produtos.csv");
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                });
                document.getElementById('import-csv-file').addEventListener('change', handleCSVFileSelect);
                document.getElementById('btn-confirm-import').addEventListener('click', handleConfirmImport);
                document.getElementById('btn-cancel-import').addEventListener('click', () => {
                     document.getElementById('form-importar-planilha-container').style.display = 'none';
                     document.getElementById('import-csv-file').value = '';
                     document.getElementById('import-preview-container').innerHTML = '';
                     document.getElementById('import-actions').style.display = 'none';
                });

                // --- Listeners Página de Vendas ---
                document.getElementById('btn-show-nova-venda-form').addEventListener('click', () => {
                    document.getElementById('form-nova-venda-container').style.display = 'block';
                    document.getElementById('btn-show-nova-venda-form').style.display = 'none';
                    document.getElementById('form-nova-venda').reset();
                    itensVendaTemporarios = [];
                    updateCurrentSaleUI();
                    populateSalesProductSelect();
                });
                document.getElementById('btn-add-produto-venda').addEventListener('click', () => {
                    const select = document.getElementById('venda-produto-select');
                    const selectedOption = select.options[select.selectedIndex];
                    const produtoId = selectedOption.value;
                    if (!produtoId) { showToast('Selecione um produto.', 'error'); return; }

                    const quantidadeInput = document.getElementById('venda-produto-qtd');
                    const quantidade = parseInt(quantidadeInput.value);
                    const estoqueDisponivel = parseInt(selectedOption.dataset.stock);

                    if (isNaN(quantidade) || quantidade <= 0) { showToast('Insira uma quantidade válida.', 'error'); return; }
                    
                    const itemJaNoCarrinho = itensVendaTemporarios.find(item => item.productId === produtoId);
                    const qtdTotalNoCarrinho = (itemJaNoCarrinho ? itemJaNoCarrinho.quantity : 0) + quantidade;

                    if (qtdTotalNoCarrinho > estoqueDisponivel) { showToast(`Estoque insuficiente! Apenas ${estoqueDisponivel} unidades disponíveis.`, 'error'); return; }
                    
                    if (itemJaNoCarrinho) {
                        itemJaNoCarrinho.quantity += quantidade;
                        itemJaNoCarrinho.subtotal = itemJaNoCarrinho.quantity * itemJaNoCarrinho.unitPrice;
                    } else {
                        itensVendaTemporarios.push({
                            productId: produtoId, name: selectedOption.dataset.name, quantity: quantidade,
                            unitPrice: parseFloat(selectedOption.dataset.price),
                            subtotal: quantidade * parseFloat(selectedOption.dataset.price)
                        });
                    }
                    updateCurrentSaleUI();
                    quantidadeInput.value = 1;
                    select.value = "";
                });
                document.getElementById('venda-itens-lista').addEventListener('click', event => {
                    if (event.target.classList.contains('remove-item-btn') || event.target.closest('.remove-item-btn')) {
                        const button = event.target.closest('.remove-item-btn');
                        const indexToRemove = parseInt(button.dataset.index);
                        itensVendaTemporarios.splice(indexToRemove, 1);
                        updateCurrentSaleUI();
                    }
                });
                 document.getElementById('form-nova-venda').addEventListener('submit', handleNewSaleSubmit);
                 document.getElementById('btn-cancel-nova-venda').addEventListener('click', () => {
                    document.getElementById('form-nova-venda-container').style.display = 'none';
                    document.getElementById('btn-show-nova-venda-form').style.display = 'inline-flex';
                 });
                 document.getElementById('venda-desconto').addEventListener('input', updateCurrentSaleUI);
                
                // --- Listener Página Clientes ---
                document.getElementById('clientes-page').addEventListener('click', (event) => {
                    const sellAgainBtn = event.target.closest('.btn-sell-again');
                    if (sellAgainBtn) {
                        const name = sellAgainBtn.dataset.name;
                        const phone = sellAgainBtn.dataset.phone;
                        setActivePage('vendas-page', { clientName: name, clientPhone: phone });
                    }
                });

                // --- Listeners Página de Despesas ---
                document.getElementById('form-add-custo-fixo').addEventListener('submit', handleAddFixedCost);
                document.getElementById('form-add-custo-variavel').addEventListener('submit', handleAddVariableCost);
                document.getElementById('form-add-custo-frete').addEventListener('submit', handleAddFreightCost);
                document.getElementById('form-add-custo-imposto').addEventListener('submit', handleAddTaxCost);
                document.getElementById('despesas-page').addEventListener('click', event => {
                    const removeBtn = event.target.closest('.remove-cost-btn');
                    if (removeBtn) {
                        handleRemoveCost(removeBtn.dataset.type, removeBtn.dataset.id);
                    }
                });

                // --- Listeners Página Liberdade Financeira ---
                document.getElementById('btn-show-add-debt-form').addEventListener('click', () => {
                     document.getElementById('form-add-debt-container').style.display = 'block';
                     document.getElementById('btn-show-add-debt-form').style.display = 'none';
                });
                document.getElementById('btn-cancel-add-debt').addEventListener('click', () => {
                     document.getElementById('form-add-debt-container').style.display = 'none';
                     document.getElementById('btn-show-add-debt-form').style.display = 'inline-flex';
                });
                document.getElementById('form-add-debt').addEventListener('submit', handleAddDebt);
                document.getElementById('liberdade-financeira-page').addEventListener('click', (event) => {
                    const planButton = event.target.closest('.btn-plan-payment');
                    if (planButton) setActivePage('planejamento-divida-page', planButton.dataset.debtId);
                });
                document.getElementById('btn-voltar-dividas').addEventListener('click', () => setActivePage('liberdade-financeira-page'));
                
                // --- Listeners Página Lucro Certo ---
                const lucroMargemSlider = document.getElementById('lucro-margem-slider');
                const lucroMargemInput = document.getElementById('lucro-margem-input');
                lucroMargemSlider.addEventListener('input', () => {
                    lucroMargemInput.value = lucroMargemSlider.value;
                    calculateAndDisplayLucroCerto();
                });
                lucroMargemInput.addEventListener('input', () => {
                    lucroMargemSlider.value = lucroMargemInput.value;
                    calculateAndDisplayLucroCerto();
                });
                document.getElementById('lucro-produto-select').addEventListener('change', handleLucroCertoProductSelect);
                document.getElementById('btn-salvar-preco-lucro-certo').addEventListener('click', handleSalvarPrecoLucroCerto);

                // --- Listeners Página Metas (NOVO) ---
                document.querySelectorAll('.save-goal-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        handleSaveGoal(e.target.dataset.period);
                    });
                });


                // --- Inicialização ---
                document.getElementById('current-year').textContent = new Date().getFullYear();
                setActivePage('dashboard-page');
            }

            initializeApp();

        });
    </script>
</body>
</ht
